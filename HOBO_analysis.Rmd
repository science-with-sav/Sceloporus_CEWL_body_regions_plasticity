---
title: "HOBO Logger Data for Sceloporus Climate Studies"
author: "Savannah Weaver"
output: pdf_document
toc: TRUE
---

# Packages

```{r setup, echo=T, results='hide', message=FALSE}
if (!require("tidyverse")) install.packages("tidyverse") 
library("tidyverse")
```

# Load in Data

This data was collected using Onset HOBO temperature and humidity dataloggers during the course of our experiment. See __ for full details. 

The data is in a separate file for each download for each logger, so I need to compile each of those into one dataset. 

To do this, first I compile a list of the filenames I need to read-in.

```{r, filenames}
# make a list of file names of all data to load in
filenames <- list.files(path = "data/HOBOs")
```

Next, I make a function that will read in the data from each csv, name and organize the data correctly. 

```{r, create read_HOBO_files function to get each csv data}
# make a function to read in data from each csv file and add correct identifiers
read_HOBO_files <- function(filename) {
  
  # edit the filename inputted to funtion
  # to make a unique identifier for each logger
  name <- substr(filename, 1, nchar(filename)-15)
  
  # also make an identifier for the site
  site <- substr(filename, 1, nchar(filename)-15)
  
  # read in the csv file for this given filename
  dat <- read.csv(file.path("data/HOBOs", filename),
                # each csv has headers
                header = TRUE,
                # this is what I want to rename the col headers
                col.names = c("order", "date_time_PST", "temp_C", 
                              "relative_humidity", "dew_pt_C", 
                              # the 6,7,8th cols are not data
                              # logger use info we don't need
                              "mostly_blank", "mostly_blank", "mostly_blank")
                ) %>%
    # select only the cols with data we want
    # don't need order- just an arbitrary observation identifier
    # don't need "mostly_blank" cols- unnecessary logger use info
    # but get the rest of the cols with informative data
    dplyr::select(date_time_PST, temp_C, relative_humidity, dew_pt_C) %>%
    # add a column with the name of the HOBO the data is from 
    dplyr::mutate(HOBO_ID = name)
  
  # return the dataframe for that single csv file
  dat
}
```

Finally, I apply the function I made to all of the filenames I compiled, then put all of those dataframes into one dataframe for my analyses.

This will print warnings saying that header and col.names are different lengths, because the data has extra notes on logger usage that we read-in, but get rid of.

```{r, apply read_HOBO_files function}
# apply function to get data from all csvs
all_HOBO_data <- lapply(filenames, read_HOBO_files) %>%
  # paste all data files together into one df by row
  reduce(rbind)
```



# Data Wrangling

Now that I have a full dataframe, I want to make sure all the data is there and correct. 

```{r}
str(all_HOBO_data)
summary(all_HOBO_data)
```

I need to subset the data based on a date range to extract data for actual experiment days, since the loggers run continuously. There are also NA's which are an artifact of the logger's notes.

```{r}
exp_dates <- seq(as.Date("2021-04-19"), as.Date("2021-05-18"), "days")

subset_HOBO_data <- all_HOBO_data %>%
  dplyr::filter(complete.cases(temp_C, relative_humidity)) %>%
  mutate(date_only = as.Date(date_time_PST, format = "%m/%d/%Y")) %>%
  dplyr::filter(date_only %in% exp_dates)
```

Next, format the data:

```{r}
format_HOBO_data <- subset_HOBO_data %>% 
  mutate(date_time_PST = as.POSIXct(date_time_PST, 
                                    format = "%m/%d/%Y %H:%M:%S"),
         HOBO_ID = (substr(HOBO_ID, 1, 10)), # select first 10 characters
         HOBO_ID = str_trim(HOBO_ID), # remove trailing white space
         HOBO_ID = str_replace_all(HOBO_ID, "[^A-z0-9]", "_"), # replace any special characters with underscores
         HOBO_ID = as.factor(HOBO_ID) # set class as factor
         )
summary(format_HOBO_data)
```

I'm also going to omit the data for the hot treatments that failed, since we will not be presenting that. Also, when a couple of lizards died, their loggers were moved, not always to the same treatment... So I need to look for those changes. *Finally, the time of day I started the experiment on capture day and ended the experiment varied, and we also took them out of treatment for checkups. The loggers should reflect this, so I need to find those values and exclude them.*

Check temperature values:

```{r}
format_HOBO_data %>% 
  ggplot(data = ., aes(x = temp_C)) +
  geom_histogram()
format_HOBO_data %>%
  group_by(date_only, HOBO_ID) %>%
  summarise(mean_temp = mean(temp_C)) %>%
  arrange(mean_temp, date_only)
```


# Data Cleaning

## HOBO "dry cool 1":

```{r}
format_HOBO_data %>% 
  dplyr::filter(HOBO_ID == "Dry_Cool_1") %>%
  ggplot(data = ., aes(x = date_time_PST, 
                       y = temp_C, 
                       color = HOBO_ID
                       )) +
  geom_point() + 
  geom_line() +
  geom_vline(xintercept = as.POSIXct(as.Date("2021-04-27")), 
             linetype = 4, color = "purple") +
  geom_vline(xintercept = as.POSIXct(as.Date("2021-04-29")), 
             linetype = 4, color = "purple") +
  geom_vline(xintercept = as.POSIXct(as.Date("2021-05-04")), 
             linetype = 4, color = "purple") +
  geom_vline(xintercept = as.POSIXct(as.Date("2021-05-08")), 
             linetype = 4, color = "purple") +
  geom_vline(xintercept = as.POSIXct(as.Date("2021-05-11")), 
             linetype = 4, color = "purple") +
  geom_vline(xintercept = as.POSIXct(as.Date("2021-05-12")), 
             linetype = 4, color = "purple") +
  geom_hline(yintercept = 23) +
  geom_hline(yintercept = 29) +
  theme_classic()
```

There is room temperature/wacky data between April 27-29, and on May 4, 8, 11, and 12. 

Try excluding. For some reason the dates plotted versus filtered line up differently, which is why I filter out the date before what I plotted.

```{r}
unwanted_dates_dc1 <- as.Date(c("2021-04-26", "2021-04-27", 
                        "2021-04-28",
                        "2021-05-03", "2021-05-07", 
                        "2021-05-10", "2021-05-11"),
                        format = "%Y-%m-%d")
dc1_subset <- format_HOBO_data %>%
  dplyr::filter(HOBO_ID == "Dry_Cool_1") %>%
  dplyr::filter(date_only %nin% unwanted_dates_dc1)
```

plot again to show that we removed erroneous data:

```{r}
dc1_subset %>% 
  ggplot(data = ., aes(x = date_time_PST, 
                       y = temp_C, 
                       color = HOBO_ID
                       )) +
  geom_point() + 
  geom_line() +
  geom_vline(xintercept = as.POSIXct(as.Date("2021-04-27")), 
             linetype = 4, color = "purple") +
  geom_vline(xintercept = as.POSIXct(as.Date("2021-04-29")), 
             linetype = 4, color = "purple") +
  geom_vline(xintercept = as.POSIXct(as.Date("2021-05-04")), 
             linetype = 4, color = "purple") +
  geom_vline(xintercept = as.POSIXct(as.Date("2021-05-08")), 
             linetype = 4, color = "purple") +
  geom_vline(xintercept = as.POSIXct(as.Date("2021-05-11")), 
             linetype = 4, color = "purple") +
  geom_vline(xintercept = as.POSIXct(as.Date("2021-05-12")), 
             linetype = 4, color = "purple") +
  geom_hline(yintercept = 23) +
  geom_hline(yintercept = 29) +
  theme_classic()
```



We do NOT want data for Dry-Hot-1/2 or Humid-Hot between April 19-29. Everything else should be fine, so just filter those out.

The goal is to get everything EXCEPT those three loggers on those dates. The most straightforward way I know how to do this is to just filter out by temperature.

```{r}
filter_dates <- as.Date(c("2021-04-19", "2021-04-20", 
                       "2021-04-21", "2021-04-22",
               "2021-04-23", "2021-04-24", "2021-04-25", "2021-04-26",
               "2021-04-27", "2021-04-28", "2021-04-29"), 
               format = "%Y-%m-%d")
filter_HOBOs <- c("Dry-Hot-1 ", "Dry-Hot-2", "Humid-Hot")
unique(format_HOBO_data$HOBO_ID)


# none of these work
format_HOBO_data %>%
  dplyr::filter(HOBO_ID == 'Dry-Hot-1 ')

levels(format_HOBO_data$HOBO_ID)

`%nin%` = Negate(`%in%`)
format_HOBO_data %>%
  dplyr::filter(#HOBO_ID %in% c("Dry-Hot-1", "Dry-Hot-2", "Humid-Hot") & 
                  date_only %nin% filter_dates)


filt_dontwant_check <- format_HOBO_data %>%
  dplyr::filter(HOBO_ID %in% c("Dry-Hot-1", "Dry-Hot-2", "Humid-Hot") & 
                  date_only %in% filter_dates)

format_HOBO_data[format_HOBO_data$HOBO_ID == ('Dry-Hot-1')]

# but this works
filtered_HOBO_data <- format_HOBO_data %>%
  dplyr::filter(temp_C < 28)



```


**NOT WORKING**
```{r}

```


re-check:

```{r}
summary(format_HOBO_data)
```


# Get Means
by trail and tmt

```{r}
format_HOBO_data %>%
  group_by(HOBO_ID) %>%
  summarise(mean_temp_C = mean(temp_C),
            sd_temp_C = sd(temp_C),
            mean_humidity = mean(relative_humidity),
            sd_humidity = sd(relative_humidity))
```


















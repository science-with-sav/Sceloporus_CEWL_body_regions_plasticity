---
title: "Cal Poly Herpetology CURE - Capture Data Analyses"
authors: "Savannah Weaver"
date: "June 2021"
output: 
  github_document:
    toc: TRUE
---


# Packages

```{r setup, include=FALSE}
if (!require("tidyverse")) install.packages("tidyverse")
library("tidyverse") # workflow and plots
if (!require("zoo")) install.packages("zoo")
library("zoo") # interpolation using na.approx
if (!require("weathermetrics")) install.packages("weathermetrics")
library("weathermetrics") # F to C conversion
if (!require("PerformanceAnalytics")) install.packages("PerformanceAnalytics") 
library("PerformanceAnalytics") # pretty multicollinearity plots
if (!require("UsingR")) install.packages("UsingR")
library("UsingR")
if (!require("MASS")) install.packages("MASS")
library("MASS") # model selection & box-cox
if (!require("nlme")) install.packages("nlme")
library("nlme") # for GLMMs
if (!require("onewaytests")) install.packages("onewaytests")
library("onewaytests") # for Brown-Forsythe test
```


# Background and Goals

This data was collected April - May 2021 during a course-based undergraduate research experience (CURE) in Herpetology, taught by Emily Taylor at Cal Poly, San Luis Obispo. This part of the study was conducted to describe the variation in hydrophysiology in *Sceloporus occidentalis* and to investigate that drives that variation. Please refer to **doi:** for full details.

In this document, we investigate differences in cutaneous evaporative water loss (CEWL) across body regions and dependent on environment, body size, health, and hydration. 


# Data

### Morphometrics and Blood Data

This data was collected upon capture of each lizard.

Variables in this dataframe:
- date
- collection/capture time for each lizard
- individual ID for each lizard
- sock ID used to capture each lizard (removed, not relevant to analyses)
- SVL = snout-vent length
- mass in grams
- sex
- if female, whether or not gravid (with eggs)
- which eye the blood sample was taken from
- percent hematocrit = percent of blood that's red blood cells
- osmolality = a proxy of hydration, should be inversely related to water content of a lizard (this is the average of 1-3 replicates)
- cloacal temperature at the time of CEWL measurement
- processing time for each lizard, when all measurements were finished
- hemolyzed = whether or not red blood cells burst and contaminated plasma

Before loading in this data, some incorrectly-measured hematocrit and osmolality were omitted:
- hematocrit for individuals 1-16, due to observer error
- osmolality for individual 19, due to instrumental error

```{r morpho blood data}
# load and format data
morpho_blood_dat <- read.csv("./data/Herpetology_Data.csv", # filename
                             na.strings=c("","NA") # fix empty cells
                             ) %>%
  dplyr::mutate(# put date and time together
                collect_date_time = (paste(date, collect_time)), 
                # replace some date-time values that have missing times
                collect_date_time = replace(collect_date_time, 
                                            collect_date_time == "4/5/21 NA", NA),
                # correctly format date-time variable
                collect_date_time = as.POSIXct(collect_date_time, 
                                               format = "%m/%d/%y %H:%M"),
                # correctly format date-only variable
                date = as.Date(date, format = "%m/%d/%y"),
                # correctly format collection time variable
                # format extracts just time after posix adds arbitrary date
                collect_time = (as.POSIXct(collect_time, format = "%H:%M")),
                # correctly format processing time variable
                processing_time = (as.POSIXct(processing_time, format = "%H:%M")),
                # set sex variable as a factor, not character
                sex_M_F = as.factor(sex_M_F),
                # set gravidity variable as a factor, not character
                gravid_Y_N = as.factor(gravid_Y_N),
                # set blood sample eye variable as a factor, not character
                blood_sample_eye = as.factor(blood_sample_eye),
                # set hemolyzed variable as a factor, not character
                hemolyzed = as.factor(hemolyzed),
                # compute holding time as capture time - cloacal measurement time:
                hold_time = as.numeric(processing_time - collect_time)
                ) %>%
  # remove two columns not relevant for statistics
  dplyr::select(-sock_ID, -notes)
summary(morpho_blood_dat)

# export
write.csv(morpho_blood_dat, "exported_data/capture_hydration.csv")
```

I want to test if any IDs are missing, and which ones if so.

```{r}
test <- c(seq(1, 150, by = 1))
lost <- test[test %nin% morpho_blood_dat$individual_ID]
lost
```

Individuals 23 and 56 actually both do not exist because those numbers were skipped when assigning IDs, so we have all the individuals measured in the dataframe.




### CEWL Data

First, load it all in and merge.

Variables in this dataframe are:
- date
- time
- date_time combined variable
- individual_ID for each lizard measured
- region = where on the body CEWL was measured
- TEWL_g_m2h = CEWL measurement value in grams/sq-meter/hour
- ambient_temp_C = temperature when and where measurement was taken
- ambient_RH_percent = relative humidity when and where measurement was taken
- abs_humidity = computed from RH using formula on this website: https://carnotcycle.wordpress.com/2012/08/04/how-to-convert-relative-humidity-to-absolute-humidity/

```{r CEWL data}
# week 1
CEWL_April_05 <- read.csv("./data/capture_CEWL/4-5-21-CEWL.csv", # filename
                          na.strings=c("","NA")) %>% # fix empty cells
  # rename and select the pertinent variables/cols
  # I have to do this for each one 
  # so they all have the same number of columns for joining
  dplyr::select(date = Date, 
                Time, Status,
                ID = Comments,
                TEWL_g_m2h = TEWL..g..m2h.., # rename
                ambient_temp_C = AmbT..C., # rename
                ambient_RH_percent = AmbRH....
                )

# week 2
CEWL_April_19 <- read.csv("./data/capture_CEWL/4-19-21-CEWL.csv",
                          na.strings=c("","NA")) %>%
  dplyr::select(date = Date, 
                Time, Status,
                ID = Comments,
                TEWL_g_m2h = TEWL..g..m2h.., # rename
                ambient_temp_C = AmbT..C., # rename
                ambient_RH_percent = AmbRH....
                )

# week 3
CEWL_April_26 <- read.csv("./data/capture_CEWL/4-26-21-CEWL.csv",
                          na.strings=c("","NA")) %>%
  dplyr::select(date = Date, 
                Time, Status,
                ID = Comments,
                TEWL_g_m2h = TEWL..g..m2h.., # rename
                ambient_temp_C = AmbT..C., # rename
                ambient_RH_percent = AmbRH....
                )

# week 4
CEWL_May_3 <- read.csv("./data/capture_CEWL/5-3-21-CEWL.csv",
                          na.strings=c("","NA")) %>%
  dplyr::select(date = Date, 
                Time, Status,
                ID = Comments,
                TEWL_g_m2h = TEWL..g..m2h.., # rename
                ambient_temp_C = AmbT..C., # rename
                ambient_RH_percent = AmbRH....
                )

# week 5
CEWL_May_10 <- read.csv("./data/capture_CEWL/5-10-21-CEWL.csv",
                          na.strings=c("","NA")) %>%
  dplyr::select(date = Date, 
                Time, Status,
                ID = Comments,
                TEWL_g_m2h = TEWL..g..m2h.., # rename
                ambient_temp_C = AmbT..C., # rename
                ambient_RH_percent = AmbRH....
                )

# week 6
CEWL_May_17 <- read.csv("./data/capture_CEWL/5-17-21-CEWL.csv",
                          na.strings=c("","NA")) %>%
  dplyr::select(date = Date, 
                Time, Status,
                ID = Comments,
                TEWL_g_m2h = TEWL..g..m2h.., # rename
                ambient_temp_C = AmbT..C., # rename
                ambient_RH_percent = AmbRH....
                )

# merge all CEWL datafiles & reformat
CEWL <- CEWL_April_05 %>% # week 1
  # join with weeks 2-6
  rbind(., CEWL_April_19, 
        CEWL_April_26,
        CEWL_May_3,
        CEWL_May_10,
        CEWL_May_17
        ) %>%
  # remove any unsuccessful measurements
  dplyr::filter(Status == "Normal") %>%
  # extract individual_ID and region separately from the "ID" variable
  separate(ID, c("individual_ID", "region")) %>%
  # reformat data
  dplyr::mutate(# paste and format date-time variable
                CEWL_date_time = as.POSIXct(paste(date, Time), 
                                            format = "%m/%d/%y %I:%M:%S %p"),
                # reformat date only
                date = as.Date(date, format = "%m/%d/%y"),
                # reformat time 
                # format extracts just time after posix adds arbitrary date
                # but then it's a character again... 
                Time = format(as.POSIXct(Time, format = "%I:%M:%S %p"), 
                              format = "%H:%M:%S"),
                # format individual ID as a number
                individual_ID = as.numeric(individual_ID),
                # set body region as a factor variable after getting only the consistent characters due to typos
                region = as.factor(substring(region, 1, 4)),
                # convert RH to absolute humidity
                abs_humidity_g_m3 = ((6.112 * exp((17.67*ambient_temp_C)/(ambient_temp_C + 243.5)) * ambient_RH_percent * 2.1674) / (273.15 + ambient_temp_C))
                ) %>%
  # remove cols not relecant to stats
  dplyr::select(-Status) %>%
  # remove any rows with missing values
  dplyr::filter(complete.cases(.))
summary(CEWL)
```


Write CEWL dataframe as a csv for use in other analyses:

```{r}
write.csv(CEWL, "exported_data/capture_CEWL.csv")
```


Next, split CEWL data by region and compute the average among them.

```{r}
# select each CEWL region separately 
CEWL_dorsum <- CEWL %>%
  dplyr::filter(region == "dors") %>%
  dplyr::select(date, individual_ID, 
                dorsum_TEWL_g_m2h = TEWL_g_m2h)
CEWL_ventrum <- CEWL %>%
  dplyr::filter(region == "vent") %>%
  dplyr::select(date, individual_ID, 
                ventrum_TEWL_g_m2h = TEWL_g_m2h)
CEWL_dewlap <- CEWL %>%
  dplyr::filter(region == "dewl") %>%
  dplyr::select(date, individual_ID, 
                dewlap_TEWL_g_m2h = TEWL_g_m2h)
CEWL_head <- CEWL %>%
  dplyr::filter(region == "head") %>%
  dplyr::select(date, individual_ID, 
                head_TEWL_g_m2h = TEWL_g_m2h)
CEWL_mitepatch <- CEWL %>%
  dplyr::filter(region == "mite") %>%
  dplyr::select(date, individual_ID, 
                mitepatch_TEWL_g_m2h = TEWL_g_m2h)

# also get average across body regions
CEWL_avg <- CEWL %>%
  group_by(individual_ID) %>%
  summarise(avg_CEWL = mean(TEWL_g_m2h)) %>%
  dplyr::select(individual_ID, avg_CEWL)
```


Finally, rearrange and re-join CEWL data.

```{r join data}
# join all CEWL regions to morpho and blood data
data_full <- morpho_blood_dat %>%
  left_join(CEWL_dorsum, by = c("date", "individual_ID")) %>%
  left_join(CEWL_ventrum, by = c("date", "individual_ID")) %>%
  left_join(CEWL_dewlap, by = c("date", "individual_ID")) %>%
  left_join(CEWL_head, by = c("date", "individual_ID")) %>%
  left_join(CEWL_mitepatch, by = c("date", "individual_ID")) %>%
  left_join(CEWL_avg, by = "individual_ID")
```


### Weather Data

This data was obtained from http://www.itrc.org/databases/precip/ (Adcon Server Data) to test the effect of ambient conditions on CEWL. This is different from the ambient conditions already measured with CEWL, which are the temperature and humidity around the measurement device at the time of measurement. We think that the temperature, humidity, wind speed, and solar radiation the lizard was exposed to prior to capture may also affect CEWL.

tbd = daylight savings

```{r}
# load in csvs and put all in one dataframe
weather <- read.csv("./data/weather/4_5Weather.csv", sep = ';') %>%
  rbind(read.csv("./data/weather/4_19Weather.csv", sep = ';')) %>%
  rbind(read.csv("./data/weather/5_3Weather.csv", sep = ';')) %>%
  rbind(read.csv("./data/weather/5_10Weather.csv", sep = ';')) %>%
  rbind(read.csv("./data/weather/5_17Weather.csv", sep = ';')) %>%
  # add a variable for combined date-time
  mutate(collect_date_time = as.POSIXct(paste(Date, Time),
                                format = "%m/%d/%y %I:%M:%S %p")) %>%
  # remove lonely date and time
  dplyr::select(-Date, -Time)
```

The weather data is only every 15 minutes, but I want to match it to any minute measurement, so I need to interpolate the values for each minute.

First, make a separate dataframe with every minute for each of those days.

```{r}
all_times <- data.frame(collect_date_time = c(# April 5
                           seq(from = as.POSIXct("2021-04-05 10:00"),
                               to = as.POSIXct("2021-04-05 16:00"),
                               by="min"),
                           # April 19
                           seq(from = as.POSIXct("2021-04-19 10:00"),
                               to = as.POSIXct("2021-04-19 16:00"),
                               by="min"),
                           # April 26
                           seq(from = as.POSIXct("2021-04-26 10:00"),
                               to = as.POSIXct("2021-04-26 16:00"),
                               by="min"),
                           # May 3
                           seq(from = as.POSIXct("2021-05-03 10:00"),
                               to = as.POSIXct("2021-05-03 16:00"),
                               by="min"),
                           # May 10
                           seq(from = as.POSIXct("2021-05-10 10:00"),
                               to = as.POSIXct("2021-05-10 16:00"),
                               by="min"),
                           # May 17
                           seq(from = as.POSIXct("2021-05-17 10:00"),
                               to = as.POSIXct("2021-05-17 16:00"),
                               by="min")
                           ))

```

Next, merge the weather data into the times dataframe and interpolate the temperature and humidity between measurements.

```{r}
all_times_weather <- all_times %>% # time only dataframe
  # add weather measurements based on matching date-time
  left_join(weather, by = 'collect_date_time') %>%
  # convert temperature units, thanks America
  mutate(temp_C = fahrenheit.to.celsius(Temperature_F, round = 2),
         # interpolate temperatures
         temp_C_interpol = na.approx(temp_C),
         # interpolate humidities
         RH_percent_interpol = na.approx(RH_percent),
         # interpolate Wind Speeds
         Wind_mph_interpol = na.approx(Wind_Speed_mph),
         # interpolate solar radiation
         Solar_rad_Wm2_interpol = na.approx(Pyranometer_W_m),
         # compute absolute humidity
         abs_humidity_g_m3_interpol = ((6.112 * exp((17.67*temp_C_interpol)/(temp_C_interpol + 243.5)) * RH_percent_interpol * 2.1674) / (273.15 + temp_C_interpol))
         ) %>%
  # keep only the relevant variables
  dplyr::select(collect_date_time, 
                temp_C_interpol, 
                RH_percent_interpol, 
                abs_humidity_g_m3_interpol,
                Wind_mph_interpol, 
                Solar_rad_Wm2_interpol)
summary(all_times_weather)
```



### Rain & Humidity

Load data:

```{r}
rain_humd <- read.csv("./data/weather/rain_humidity.csv", sep = ';') %>%
  # add a variable for combined date-time
  mutate(date_time = as.POSIXct(paste(Date, Time),
                                format = "%m/%d/%y %I:%M:%S %p"),
         # fix date only variable format
         Date = as.POSIXct(Date, format = "%m/%d/%y"),
         # convert temperature units, thanks America
         temp_C = fahrenheit.to.celsius(Temp_F, round = 2),
         # compute absolute humidity
         abs_humidity_g_m3 = ((6.112 * exp((17.67*temp_C)/(temp_C + 243.5)) * RH_percent * 2.1674) / (273.15 + temp_C))
         )
summary(rain_humd)
```

Compute cumulative values in the days leading up to lizard capture days:

```{r}
# for April 5
cumul_water_4_05 <- rain_humd %>%
  dplyr::filter(Date < '2021-04-05' & Date > '2021-03-28') %>%
  summarise(total_precip = sum(Precip_inches),
            avg_abs_humd = mean(abs_humidity_g_m3)
            ) %>%
  mutate(sample_date = as.Date("2021-04-05", format = "%Y-%m-%d"))

# for April 19
cumul_water_4_19 <- rain_humd %>%
  dplyr::filter(Date < '2021-04-19' & Date > '2021-04-11') %>%
  summarise(total_precip = sum(Precip_inches),
            avg_abs_humd = mean(abs_humidity_g_m3)
            ) %>%
  mutate(sample_date = as.Date("2021-04-19", format = "%Y-%m-%d"))

# for April 26
cumul_water_4_26 <- rain_humd %>%
  dplyr::filter(Date < '2021-04-26' & Date > '2021-03-18') %>%
  summarise(total_precip = sum(Precip_inches),
            avg_abs_humd = mean(abs_humidity_g_m3)
            ) %>%
  mutate(sample_date = as.Date("2021-04-26", format = "%Y-%m-%d"))

# for May 3
cumul_water_5_03 <- rain_humd %>%
  dplyr::filter(Date < '2021-05-03' & Date > '2021-04-25') %>%
  summarise(total_precip = sum(Precip_inches),
            avg_abs_humd = mean(abs_humidity_g_m3)
            ) %>%
  mutate(sample_date = as.Date("2021-05-03", format = "%Y-%m-%d"))

# for May 10
cumul_water_5_10 <- rain_humd %>%
  dplyr::filter(Date < '2021-05-10' & Date > '2021-05-02') %>%
  summarise(total_precip = sum(Precip_inches),
            avg_abs_humd = mean(abs_humidity_g_m3)
            ) %>%
  mutate(sample_date = as.Date("2021-05-10", format = "%Y-%m-%d"))

# for May 17
cumul_water_5_17 <- rain_humd %>%
  dplyr::filter(Date < '2021-05-17' & Date > '2021-05-09') %>%
  summarise(total_precip = sum(Precip_inches),
            avg_abs_humd = mean(abs_humidity_g_m3)
            ) %>%
  mutate(sample_date = as.Date("2021-05-17", format = "%Y-%m-%d"))

# join them
cumul_water <- cumul_water_4_05 %>%
  rbind(cumul_water_4_19) %>%
  rbind(cumul_water_4_26) %>%
  rbind(cumul_water_5_03) %>%
  rbind(cumul_water_5_10) %>%
  rbind(cumul_water_5_17) %>%
  mutate(prior_rain_Y_N = c("N", "N", "N", "Y", "N", "Y"))
```




### Join Data 

There are several CEWL measurements for each of the other measures, so I'm going to join two ways. Each way allows slightly different analyses.

First, with CEWL as the primary dataframe. This means each of the other variables will be duplicated for each lizards CEWL measurements.

```{r}
all_data_long <- CEWL %>%
  left_join(morpho_blood_dat, 
            by = c("date", "individual_ID")
            ) %>%
  left_join(all_times_weather, 
            by = c("collect_date_time")
            )
```

Second, with morpho_blood_dat as the primary dataframe, and each region's CEWL measurement as an individual column.

```{r}
all_data_wide <- morpho_blood_dat %>%
  left_join(cumul_water, 
            by = c("date" = "sample_date")
            ) %>%
  left_join(all_times_weather, 
            by = c("collect_date_time")
            ) %>%
  left_join(CEWL_dewlap,
            by = c("date", "individual_ID")
            ) %>%
  left_join(CEWL_dorsum,
            by = c("date", "individual_ID")
            ) %>%
  left_join(CEWL_head,
            by = c("date", "individual_ID")
            ) %>%
  left_join(CEWL_mitepatch,
            by = c("date", "individual_ID")
            ) %>%
  left_join(CEWL_ventrum,
            by = c("date", "individual_ID")
            )
```

Join the osmolality and rain by week data:

```{r}
osml_rain_wk <- cumul_water %>%
  left_join(mean_blood_dat, by = c("sample_date" = "date")) %>%
  # compute osml change between weeks
  mutate(osml_change = mean_osml - lag(mean_osml))
```


### Export Data

I want to save the data as csvs for loading into other analyses.

```{r}
write.csv(all_data_long, "exported_data/capture_data_long.csv")
write.csv(all_data_wide, "exported_data/capture_data_wide.csv")
```




# Check Data Distributions

## Histograms & Q-Q Plots

### SVL

not normally distributed, skewed left
 
```{r}
all_data_wide %>%
  ggplot(., aes(x = SVL_mm)) +
  geom_histogram(color = "black", fill="steelblue", bins=50) + 
  theme_classic() +
  xlab("SVL (mm)") + 
  ylab("Count")
simple.eda(all_data_wide$SVL_mm)
# Normality test if p > .05, data is normal. Data is not normal.
shapiro.test(all_data_wide$SVL_mm)
```

### Mass

slightly skewed left, but nearly a bell curve

```{r}
all_data_wide %>%
  ggplot(., aes(x = mass_g)) +
  geom_histogram(color = "black", fill="steelblue", bins=50) + 
  theme_classic() +
  xlab("Mass (g)") + 
  ylab("Count")
simple.eda(all_data_wide$mass_g)
# Normality test if p > .05, data is normal. Data is not normal.
shapiro.test(all_data_wide$mass_g)
```

### Hematocrit 

looks pretty normally distributed around ~35%, but not statistically normal

```{r}
all_data_wide %>%
  ggplot(., aes(x = hematocrit_percent)) +
  geom_histogram(color = "black", fill="steelblue", bins=50) + 
  theme_classic() +
  xlab("Hematocrit (%)") + 
  ylab("Count")
simple.eda(all_data_wide$hematocrit_percent)
# Normality test if p > .05, data is normal. Data is not normal
shapiro.test(all_data_wide$hematocrit_percent)
```

### Osmolality 

pretty normally distributed around ~370:
only variable to pass normality test (LOL)

```{r}
all_data_wide %>%
  ggplot(., aes(x = osmolality_mmol_kg)) +
  geom_histogram(color = "black", fill="steelblue", bins=50) + 
  theme_classic() +
  xlab("Osmolality (mmol/kg)") + 
  ylab("Count")
simple.eda(all_data_wide$osmolality_mmol_kg)
# Normality test if p > .05, data is normal. Data is normal
shapiro.test(all_data_wide$osmolality_mmol_kg)
```

### Cloacal Temperature 

seems normally distributed, but not normal

```{r}
all_data_wide %>%
  ggplot(., aes(x = cloacal_temp_C)) +
  geom_histogram(color = "black", fill="steelblue", bins=10) + 
  theme_classic() +
  xlab("cloacal temperature (C)") + 
  ylab("Count")
simple.eda(all_data_wide$cloacal_temp_C)
# Normality test if p > .05, data is normal. Data is not normal
shapiro.test(all_data_wide$cloacal_temp_C)
```




### CEWL

```{r}
all_data_long %>%
  ggplot(., aes(x = TEWL_g_m2h)) +
  geom_histogram(color = "black", fill="steelblue", bins=50) + 
  theme_classic() +
  xlab("TEWL_g_m2h") + 
  ylab("Count")
simple.eda(all_data_long$TEWL_g_m2h)
# Normality test if p > .05, data is normal. Data is not normal
shapiro.test(all_data_long$TEWL_g_m2h)

# Log transformation
shapiro.test(log(all_data_long$TEWL_g_m2h))
# p-value improves to  0.00548, but is still significant

# also check variance
leveneTest(TEWL_g_m2h ~ region, data=all_data_long)
# Unequal variances, p val = 3.383e-10
```


### Dewlap CEWL 

very skewed to the right

```{r}
all_data_wide %>%
  ggplot(., aes(x = dewlap_TEWL_g_m2h)) +
  geom_histogram(color = "black", fill="steelblue", bins=50) + 
  theme_classic() +
  xlab("Dewlap CEWL (g/m^2/h)") + 
  ylab("Count")
simple.eda(all_data_wide$dewlap_TEWL_g_m2h)
# Normality test if p > .05, data is normal. Data is not normal
shapiro.test(all_data_wide$dewlap_TEWL_g_m2h)

# Log transformation
shapiro.test(log(all_data_wide$dewlap_TEWL_g_m2h))
# p-value improves to 0.007235, but is still significant

```

### Dorsum CEWL 

slightly skewed to the right

```{r}
all_data_wide %>%
  ggplot(., aes(x = dorsum_TEWL_g_m2h)) +
  geom_histogram(color = "black", fill="steelblue", bins=40) + 
  theme_classic() +
  xlab("Dorsum CEWL (g/m^2/h)") + 
  ylab("Count")
simple.eda(all_data_wide$dorsum_TEWL_g_m2h)
# Normality test if p > .05, data is normal. Data is not normal
shapiro.test(all_data_wide$dorsum_TEWL_g_m2h)

# log transform
shapiro.test(log(all_data_wide$dorsum_TEWL_g_m2h))

```

### Head CEWL 

very skewed to the right

```{r}
all_data_wide %>%
  ggplot(., aes(x = head_TEWL_g_m2h)) +
  geom_histogram(color = "black", fill="steelblue", bins=40) + 
  theme_classic() +
  xlab("Head CEWL (g/m^2/h)") + 
  ylab("Count")
simple.eda(all_data_wide$head_TEWL_g_m2h)
# Normality test if p > .05, data is normal. Data is not normal
shapiro.test(all_data_wide$head_TEWL_g_m2h)

# Log transform made data normal
shapiro.test(log(all_data_wide$head_TEWL_g_m2h))

```

### Mite Patch CEWL 

very skewed to the right

```{r}
all_data_wide %>%
  ggplot(., aes(x = mitepatch_TEWL_g_m2h)) +
  geom_histogram(color = "black", fill="steelblue", bins=40) + 
  theme_classic() +
  xlab("Mite Patch CEWL (g/m^2/h)") + 
  ylab("Count")
simple.eda(all_data_wide$mitepatch_TEWL_g_m2h)
# Normality test if p > .05, data is normal. Data is not normal
shapiro.test(all_data_wide$mitepatch_TEWL_g_m2h)

# Log transform p-0.04107, close to being normal
shapiro.test(log(all_data_wide$mitepatch_TEWL_g_m2h))
```

### Ventrum CEWL 

slightly skewed to the right, somewhat evenly distributed, but not statistically normal

```{r}
all_data_wide %>%
  ggplot(., aes(x = ventrum_TEWL_g_m2h)) +
  geom_histogram(color = "black", fill="steelblue", bins=30) + 
  theme_classic() +
  xlab("Ventrum CEWL (g/m^2/h)") + 
  ylab("Count")
simple.eda(all_data_wide$ventrum_TEWL_g_m2h)
# Normality test if p > .05, data is normal. Data is not normal
shapiro.test(all_data_wide$ventrum_TEWL_g_m2h)

# log transform didnt work 0.0006058
shapiro.test(log(all_data_wide$ventrum_TEWL_g_m2h))
```

### Temperature 

not normal

```{r}
all_data_wide %>%
  ggplot(., aes(x = temp_C_interpol)) +
  geom_histogram(color = "black", fill="steelblue", bins=30) + 
  theme_classic() +
  xlab("Temperature (C)") + 
  ylab("Count")
simple.eda(all_data_wide$temp_C_interpol)
# Normality test if p > .05, data is normal. Data is not normal
shapiro.test(all_data_wide$temp_C_interpol)

# log transform 
shapiro.test(log(all_data_wide$temp_C_interpol))
```

### Humidity

not normal

```{r}
all_data_wide %>%
  ggplot(., aes(x = abs_humidity_g_m3_interpol)) +
  geom_histogram(color = "black", fill="steelblue", bins=30) + 
  theme_classic() +
  xlab("Absolute Humidity (g/m^3)") + 
  ylab("Count")
simple.eda(all_data_wide$abs_humidity_g_m3_interpol)
# Normality test if p > .05, data is normal. Data is not normal
shapiro.test(all_data_wide$abs_humidity_g_m3_interpol)

# Doesn't fix non normality
shapiro.test(log(all_data_wide$abs_humidity_g_m3_interpol))

```

### Wind

not normal

```{r}
all_data_wide %>%
  ggplot(., aes(x = Wind_mph_interpol)) +
  geom_histogram(color = "black", fill="steelblue", bins=30) + 
  theme_classic() +
  xlab("Wind Speed (mph)") + 
  ylab("Count")
simple.eda(all_data_wide$Wind_mph_interpol)
# Normality test if p > .05, data is normal. Data is not normal
shapiro.test(all_data_wide$Wind_mph_interpol)

# ln transformation doesn't fix non normality
shapiro.test(log(all_data_wide$Wind_mph_interpol))
```

### Solar Radiation

not normal

```{r}
all_data_wide %>%
  ggplot(., aes(x = Solar_rad_Wm2_interpol)) +
  geom_histogram(color = "black", fill="steelblue", bins=30) + 
  theme_classic() +
  xlab("Solar Radiation (W/m^2)") + 
  ylab("Count")
simple.eda(all_data_wide$Solar_rad_Wm2_interpol)
# Normality test if p > .05, data is normal. Data is not normal
shapiro.test(all_data_wide$Solar_rad_Wm2_interpol)

# Doesn't fix non normality
shapiro.test(log(all_data_wide$Solar_rad_Wm2_interpol))
```

## Conclusion

Osmolality was the only normally distributed variable. 

The following variables were each had non-normal distributions:
- SVL (skewed left)
- mass (skewed left)
- hct (skewed both ways??)
- cloacal temp (skewed right)
- CEWL overall (skewed right)
- CEWL for each region individually (skewed right)
- capture temp (multimodal)
- capture humidity (multimodal and skewed left)
- wind speed (multimodal)
- solar radiation (multimodal)

This will be important to keep in mind going forward. Once we have our model, we will need to very very carefully check assumptions.



## Transformations

Check whether simple log-transformations improve normality, then investigate potential other transformations if log-transforming does not work.

### SVL

Was very skewed left. 

```{r}
# log transform
SVL_transf <- morpho_blood_dat %>%
  dplyr::select(SVL_mm) %>%
  mutate(SVL_transf = log10(SVL_mm))

# check normality again
SVL_transf %>%
  ggplot(., aes(x = SVL_transf)) +
  geom_histogram(color = "black", fill="steelblue", bins=50) + 
  theme_classic() +
  xlab("Log-transformed SVL (mm)") + 
  ylab("Count")
simple.eda(SVL_transf$SVL_transf)
shapiro.test(SVL_transf$SVL_transf)
```

It looks exactly the same as the original disribution using ln or log10. Next, try 1/SVL:

```{r}
# reciprocal transform
SVL_transf2 <- morpho_blood_dat %>%
  dplyr::select(SVL_mm) %>%
  mutate(SVL_transf = 1/(SVL_mm))

# check normality again
SVL_transf2 %>%
  ggplot(., aes(x = SVL_transf)) +
  geom_histogram(color = "black", fill="steelblue", bins=50) + 
  theme_classic() +
  xlab("1/ SVL (mm)") + 
  ylab("Count")
simple.eda(SVL_transf2$SVL_transf)
shapiro.test(SVL_transf2$SVL_transf)
```

Now the skew is just the other direction...

Try box-cox:

```{r}
SVL_SLR <- lm(SVL_mm ~ 1, data = morpho_blood_dat)

MASS::boxcox(SVL_SLR, lambda = seq(6.5, 7, by = 0.1))
```

Try a transformation of SVL^6.7:

```{r}
# boxcox lambda = 6.7 transform
SVL_transf3 <- morpho_blood_dat %>%
  dplyr::select(SVL_mm) %>%
  mutate(SVL_transf = (SVL_mm)^6.7)

# check normality again
SVL_transf3 %>%
  ggplot(., aes(x = SVL_transf)) +
  geom_histogram(color = "black", fill="steelblue", bins=50) + 
  theme_classic() +
  xlab("1/ SVL (mm)") + 
  ylab("Count")
simple.eda(SVL_transf3$SVL_transf)
shapiro.test(SVL_transf3$SVL_transf)
```


### mass

```{r}

```

### hematocrit 

```{r}

```


### cloacal temperature 

```{r}

```

### dewlap CEWL 

```{r}

```

### dorsum CEWL 

```{r}

```

### head CEWL 

```{r}

```

### mite patch CEWL 

```{r}

```

### ventrum CEWL 

```{r}

```





# Basic Figs & GLMs

## What affects hydration & health?

Potential relationships:
- Hct or Osml ~ SVL, mass, sex, gravidity, eye, hemolyzed, week

### Hct ~ SVL

- No sig relationship

```{r}
# plot
all_data_wide %>% 
  ggplot(data = .) + 
  geom_point(aes(x = SVL_mm,
                 y = hematocrit_percent, 
                 ), 
             size = 1, 
             alpha = 0.6) + 
  stat_smooth(aes(x = SVL_mm, 
                  y = hematocrit_percent, 
                  ), 
              formula = y ~ x, 
              method = "lm", 
              color = "gray",
              se = F, 
              size = 1.6, 
              alpha = 1 ) + 
  theme_classic() + 
  xlab("SVL") + 
  ylab("Hct") + 
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 12),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 10),
        legend.text.align = 0,
)

# glm
glm_hct_SVL <- lm(hematocrit_percent ~ SVL_mm,
           data = all_data_wide)
summary(glm_hct_SVL)
```



### Osml ~ SVL

- no sig relationship

```{r}
all_data_wide %>% 
  ggplot(data = .) + 
  geom_point(aes(x = SVL_mm,
                 y = osmolality_mmol_kg, 
                 ), 
             size = 1, 
             alpha = 0.6) + 
  stat_smooth(aes(x = SVL_mm, 
                  y = osmolality_mmol_kg, 
                  ), 
              formula = y ~ x, 
              method = "lm", 
              color = "gray",
              se = F, 
              size = 1.6, 
              alpha = 1 ) + 
  theme_classic() + 
  xlab("SVL") + 
  ylab("Osmolality") + 
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 12),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 10),
        legend.text.align = 0,
)

# glm
glm_osml_SVL <- lm(osmolality_mmol_kg ~ SVL_mm,
           data = all_data_wide)
summary(glm_osml_SVL)
```


### Hct ~ Mass

- no sig relationship

```{r}
all_data_wide %>% 
  ggplot(data = .) + 
  geom_point(aes(x = mass_g,
                 y = hematocrit_percent, 
                 ), 
             size = 1, 
             alpha = 0.6) +
  stat_smooth(aes(x = mass_g, 
                  y = hematocrit_percent, 
                  ), 
              formula = y ~ x, 
              method = "lm", 
              color = "gray",
              se = F, 
              size = 1.6, 
              alpha = 1 ) + 
  theme_classic() + 
  xlab("Mass") + 
  ylab("Hematocrit") + 
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 12),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 10),
        legend.text.align = 0,
)

# glm
glm_hct_mass <- lm(hematocrit_percent ~ mass_g,
           data = all_data_wide)
summary(glm_hct_mass)
```

### Osml ~ Mass

- no sig relationship

```{r}
all_data_wide %>% 
  ggplot(data = .) + 
  geom_point(aes(x = mass_g,
                 y = osmolality_mmol_kg, 
                 ), 
             size = 1, 
             alpha = 0.6) + 
  stat_smooth(aes(x = mass_g, 
                  y = osmolality_mmol_kg), 
              formula = y ~ x, 
              method = "lm", 
              se = F, 
              color = "gray",
              size = 1.6, 
              alpha = 1 ) + 
  theme_classic() + 
  xlab("Mass") + 
  ylab("Osmolality") + 
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 12),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 10),
        legend.text.align = 0,
)

# glm
glm_osml_mass <- lm(osmolality_mmol_kg ~ mass_g,
           data = all_data_wide)
summary(glm_osml_mass)
```


### Hct ~ Sex

- sig relationship, males have a higher hematocrit %

```{r}
all_data_wide %>% 
  ggplot(data = .) + 
  geom_boxplot(aes(x = sex_M_F, 
                   y = hematocrit_percent, 
                   color = sex_M_F
                   ), 
               size = 1,
               alpha = 1) + 
  theme_classic() + 
  xlab("Sex") + 
  ylab("Hematocrit (%)") + 
  annotate("text", x = 1.5, y = 45, 
           label = "paste(italic(p), \" = 0.0152\")", 
           parse = TRUE,
           size = 6) +
  ylim(10, 50) +
  scale_x_discrete(labels = c("F" = "Female",
                              "M" = "Male")) +
  scale_color_brewer(palette = "Set2") +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 18),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 14),
        legend.text.align = 0,
        legend.position = "none"
) -> hct_sex_fig
hct_sex_fig

# export figure
#ggsave(filename = "hct_sex_fig.tiff",
 #      plot = hct_sex_fig,
  #     path = "./final_figures",
   #    device = "tiff",
    #   dpi = 1200,
     #  width = 6, height = 4)

# glms
aov_hct_sex <- aov(hematocrit_percent ~ sex_M_F,
           data = all_data_wide)
TukeyHSD(aov_hct_sex)
glm_hct_sex_mass <- glm(hematocrit_percent ~ sex_M_F*mass_g - mass_g,
           data = all_data_wide)
summary(glm_hct_sex_mass)
```

Hematocrit is significantly predicted by sex, but the interaction between sex and mass is ~nonexistent. 


### Osml ~ Sex

females have higher osmolarity (nonsig)

```{r}
all_data_wide %>% 
  ggplot(data = .) + 
  geom_boxplot(aes(x = sex_M_F, 
                   y = osmolality_mmol_kg, 
                   color = sex_M_F
                   ), 
               size = 1,
               alpha = 0.6) + 
  scale_colour_manual(name = "Sex", 
                      values = c("green4", "salmon1") ) +
  theme_classic() + 
  xlab("Sex") + 
  ylab("Osmolality") + 
  theme(text = element_text(color = "black", family = "sans", size = 12),
        axis.text = element_text(color = "black", family = "sans", size = 10),
        legend.text.align = 0,
        legend.position = "none"
)

# glm
glm_osml_sex <- lm(osmolality_mmol_kg ~ sex_M_F,
           data = all_data_wide)
summary(glm_osml_sex)
```

### Hct ~ Gravidity

- no sig diff

```{r}
all_data_wide %>% 
  dplyr::filter(sex_M_F == 'F') %>%
  ggplot(data = .) + 
  geom_boxplot(aes(x = gravid_Y_N, 
                   y = hematocrit_percent, 
                   color = gravid_Y_N
                   ), 
               size = 1,
               alpha = 0.6) + 
  scale_colour_manual(name = "Gravid", 
                      values = c("green4", "salmon1") ) +
  theme_classic() + 
  xlab("Gravid (Females Only)") + 
  ylab("Hematocrit") + 
  theme(text = element_text(color = "black", family = "sans", size = 12),
        axis.text = element_text(color = "black", family = "sans", size = 10),
        legend.text.align = 0,
        legend.position = "none"
)

# glm
glm_hct_gravid <- lm(hematocrit_percent ~ gravid_Y_N,
           data = all_data_wide)
summary(glm_hct_gravid)
```

### Osml ~ Gravidity

gravid F have higher osmolarity (nonsig)

```{r}
all_data_wide %>% 
  dplyr::filter(sex_M_F == 'F') %>%
  ggplot(data = .) + 
  geom_boxplot(aes(x = gravid_Y_N, 
                   y = osmolality_mmol_kg, 
                   color = gravid_Y_N
                   ), 
               size = 1,
               alpha = 0.6) + 
  scale_colour_manual(name = "Gravid", 
                      values = c("green4", "salmon1") ) +
  theme_classic() + 
  xlab("Gravid (Females Only)") + 
  ylab("Osmolality") + 
  theme(text = element_text(color = "black", family = "sans", size = 12),
        axis.text = element_text(color = "black", family = "sans", size = 10),
        legend.text.align = 0,
        legend.position = "none"
)

# glm
glm_osml_gravid <- lm(osmolality_mmol_kg ~ gravid_Y_N,
           data = all_data_wide)
summary(glm_osml_gravid)
```

### Hct ~ Sample Eye

Actually, any blood samples not taken from the right eye ended up being excluded or didn't have hematocrit values, so we can't test this difference.

```{r}
all_data_wide %>% 
  dplyr::filter(blood_sample_eye %in% c("R", "L")) %>%
  ggplot(data = .) + 
  geom_boxplot(aes(x = blood_sample_eye, 
                   y = hematocrit_percent, 
                   color = blood_sample_eye
                   ), 
               size = 1,
               alpha = 0.6) + 
  scale_colour_manual(name = "Blood Sample Eye", 
                      values = c("green4", "salmon1") ) +
  theme_classic() + 
  xlab("Blood Sample Eye") + 
  ylab("Hematocrit") + 
  theme(text = element_text(color = "black", family = "sans", size = 12),
        axis.text = element_text(color = "black", family = "sans", size = 10),
        legend.text.align = 0,
        legend.position = "none"
)

# can't do a glm
```


### Osml ~ Sample Eye

```{r}
all_data_wide %>% 
  dplyr::filter(blood_sample_eye %in% c("R", "L")) %>%
  ggplot(data = .) + 
  geom_boxplot(aes(x = blood_sample_eye, 
                   y = osmolality_mmol_kg, 
                   color = blood_sample_eye
                   ), 
               size = 1,
               alpha = 0.6) + 
  scale_colour_manual(name = "Blood Sample Eye", 
                      values = c("green4", "salmon1") ) +
  theme_classic() + 
  xlab("Blood Sample Eye") + 
  ylab("Osmolality") + 
  theme(text = element_text(color = "black", family = "sans", size = 12),
        axis.text = element_text(color = "black", family = "sans", size = 10),
        legend.text.align = 0,
        legend.position = "none"
)

# glm
glm_osml_eye <- lm(osmolality_mmol_kg ~ blood_sample_eye,
           data = all_data_wide)
summary(glm_osml_eye)
```

### Hct ~ Hemolyzed/Not

- no sig diff

```{r}
all_data_wide %>% 
  dplyr::filter(hemolyzed %in% c("Y", "N")) %>%
  ggplot(data = .) + 
  geom_boxplot(aes(x = hemolyzed, 
                   y = hematocrit_percent, 
                   color = hemolyzed
                   ), 
               size = 1,
               alpha = 0.6) + 
  scale_colour_manual(name = "Blood Sample Eye", 
                      values = c("green4", "salmon1", "green4", "salmon1") ) +
  theme_classic() + 
  xlab("Whether or not Sample Hemolyzed") + 
  ylab("Hematocrit") + 
  theme(text = element_text(color = "black", family = "sans", size = 12),
        axis.text = element_text(color = "black", family = "sans", size = 10),
        legend.text.align = 0,
        legend.position = "none"
)

# glm
glm_hct_hem <- lm(hematocrit_percent ~ hemolyzed,
           data = all_data_wide)
summary(glm_hct_hem)
```



### Osml ~ Hemolyzed/Not

```{r}
all_data_wide %>% 
  dplyr::filter(hemolyzed %in% c("Y", "N")) %>%
  ggplot(data = .) + 
  geom_boxplot(aes(x = hemolyzed, 
                   y = osmolality_mmol_kg, 
                   color = hemolyzed
                   ), 
               size = 1,
               alpha = 0.6) + 
  scale_colour_manual(name = "Blood Sample Eye", 
                      values = c("green4", "salmon1", "green4", "salmon1") ) +
  theme_classic() + 
  xlab("Whether or not Sample Hemolyzed") + 
  ylab("Osmolality") + 
  theme(text = element_text(color = "black", family = "sans", size = 12),
        axis.text = element_text(color = "black", family = "sans", size = 10),
        legend.text.align = 0,
        legend.position = "none"
)

# glm
glm_osml_hem <- lm(osmolality_mmol_kg ~ hemolyzed,
           data = all_data_wide)
summary(glm_osml_hem)
```



### Hct ~ Week

- no sig diff

```{r}
all_data_wide %>% 
  ggplot(data = .) + 
  geom_boxplot(aes(x = as.factor(date), 
                   y = hematocrit_percent, 
                   color = as.factor(date)
                   ), 
               size = 1,
               alpha = 0.6) + 
  theme_classic() + 
  xlab("Sampling Date") + 
  ylab("Hematocrit") + 
  theme(text = element_text(color = "black", family = "sans", size = 12),
        axis.text = element_text(color = "black", family = "sans", size = 10),
        legend.text.align = 0,
        legend.position = "none"
)

# glm
glm_hct_wk <- lm(hematocrit_percent ~ date,
           data = all_data_wide)
summary(glm_hct_wk)
```



### Osml ~ Week

- Sig difference in osmolarity by week

```{r}
all_data_wide %>% 
  ggplot(data = .) + 
  geom_boxplot(aes(x = as.factor(date), 
                   y = osmolality_mmol_kg, 
                   color = as.factor(date)
                   ), 
               size = 1,
               alpha = 0.6) + 
  theme_classic() + 
  xlab("Date") + 
  ylab("Osmolality (mmol / kg)") + 
  annotate("text", x = 1, y = 365, label = "a", size = 6) +
  annotate("text", x = 2, y = 390, label = "b", size = 6) +
  annotate("text", x = 3, y = 437, label = "c", size = 6) +
  annotate("text", x = 4, y = 427, label = "c", size = 6) +
  annotate("text", x = 5, y = 417, label = "d", size = 6) +
  annotate("text", x = 6, y = 447, label = "d", size = 6) +
  scale_x_discrete(labels = c("2021-04-05" = "Apr 5", 
                              "2021-04-19" = "Apr 19",
                              "2021-04-26" = "Apr 26",
                              "2021-05-03" = "May 3", 
                              "2021-05-10" = "May 10",
                              "2021-05-17" = "May 17")) +
  scale_color_brewer(palette = "Set2") +
  ylim(300, 450) +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 18),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 14),
        legend.text.align = 0,
        legend.position = "none"
) -> osml_date_fig
osml_date_fig

# export figure
#ggsave(filename = "osml_date_fig.tiff",
 #      plot = osml_date_fig,
  #     path = "./final_figures",
   #    device = "tiff",
    #   dpi = 1200,
     #  width = 6, height = 4)

# glm
glm_osml_wk <- glm(osmolality_mmol_kg ~ date,
           data = all_data_wide)
summary(glm_osml_wk)
```

There was a little rain on April 27.... could that be why there was a slight drop in osmolality?! Not sure if the May 3-> 10 drop was because of rain or fixing the osmometer, though... Need to look for better daily rainfall records, maybe look in relation to humidity?.

distinguish pairwise differences using an ANOVA:

```{r}
osml_date_aov <- aov(osmolality_mmol_kg ~ as.factor(date), 
                     data = all_data_wide)
TukeyHSD(osml_date_aov)
```


### Humidity ~ Week

- Significant difference in humidity by week

```{r}
all_data_wide %>% 
  ggplot(data = .) + 
  geom_boxplot(aes(x = as.factor(date), 
                   y = RH_percent_interpol, 
                   color = as.factor(date)
                   ), 
               size = 1,
               alpha = 0.6) + 
  theme_classic() + 
  xlab("Sampling Date") + 
  ylab("Relative Humidity") + 
  theme(text = element_text(color = "black", family = "sans", size = 12),
        axis.text = element_text(color = "black", family = "sans", size = 10),
        legend.text.align = 0,
        legend.position = "none"
)

# glm
glm_hum_wk <- glm(RH_percent_interpol ~ date,
           data = all_data_wide)
summary(glm_hum_wk)

```

try for absolute humidity:

```{r}
all_data_wide %>% 
  ggplot(data = .) + 
  geom_boxplot(aes(x = as.factor(date), 
                   y = abs_humidity_g_m3_interpol, 
                   color = as.factor(date)
                   ), 
               size = 1,
               alpha = 0.6) + 
  theme_classic() + 
  xlab("Sampling Date") + 
  ylab("Absolute Humidity") + 
  theme(text = element_text(color = "black", family = "sans", size = 12),
        axis.text = element_text(color = "black", family = "sans", size = 10),
        legend.text.align = 0,
        legend.position = "none"
)

# glm
glm_abshum_wk <- glm(abs_humidity_g_m3_interpol ~ as.factor(date),
           data = all_data_wide)
summary(glm_abshum_wk)
aov_abshum_wk <- aov(abs_humidity_g_m3_interpol ~ as.factor(date),
           data = all_data_wide)
TukeyHSD(aov_abshum_wk)
```


### Osml, Humidity, Week

```{r}
all_data_wide %>% 
  ggplot(data = .) + 
  geom_boxplot(aes(x = as.factor(date), 
                   y = osmolality_mmol_kg, 
                   color = as.factor(date)
                   ), 
               size = 1,
               alpha = 0.6) + 
  geom_jitter(aes(x = as.factor(date), 
                   y = 35*abs_humidity_g_m3_interpol)) +
  theme_classic() + 
  xlab("Sampling Date") + 
  ylab("Osmolality (mmol/kg)") + 
  theme(text = element_text(color = "black", family = "sans", size = 12),
        axis.text = element_text(color = "black", family = "sans", size = 10),
        legend.text.align = 0,
        legend.position = "none"
)
```



### Osml ~ R. Humidity

- Sig difference, negative relationship. With every percent increase in relative humidity osmolarity drops 1.2.

```{r}
all_data_wide %>% 
  ggplot(data = .) + 
  geom_point(aes(x = RH_percent_interpol,
                 y = osmolality_mmol_kg, 
                 ), 
             size = 1, 
             alpha = 0.6) + 
  stat_smooth(aes(x = RH_percent_interpol, 
                  y = osmolality_mmol_kg), 
              formula = y ~ x, 
              method = "lm", 
              se = F, 
              color = "gray",
              size = 1.6, 
              alpha = 1 ) + 
  theme_classic() + 
  xlab("Relative Humidity") + 
  ylab("Osmolality") + 
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 12),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 10),
        legend.text.align = 0,
)

# glm
glm_osml_hum <- lm(osmolality_mmol_kg ~ RH_percent_interpol,
           data = all_data_wide)
summary(glm_osml_hum)
```

That's a pretty good relationship... 


### Osml ~ Abs. Humidity

```{r}
all_data_wide %>% 
  ggplot(data = .) + 
  geom_point(aes(x = abs_humidity_g_m3_interpol,
                 y = osmolality_mmol_kg, 
                 ), 
             size = 1, 
             alpha = 0.4) + 
  stat_smooth(aes(x = abs_humidity_g_m3_interpol, 
                  y = osmolality_mmol_kg), 
              formula = y ~ x, 
              method = "lm", 
              se = F, 
              color = "royalblue",
              size = 1.6, 
              alpha = 1 ) + 
  theme_classic() + 
  xlab(bquote('Absolute Humidity at Capture (g / '*m^2*')')) + 
  ylab("Osmolality (mmol / kg)") + 
  xlim(8, 12) +
  ylim(300, 450) +
  annotate("text", x = 8.5, y = 440, 
           label = "paste(italic(R) ^ 2, \" = 0.036\")", 
           parse = TRUE,
           size = 6) +
  annotate("text", x = 8.5, y = 428, 
           label = "paste(italic(p), \" = 0.0126\")", 
           parse = TRUE,
           size = 6) +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 18),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 14),
        legend.text.align = 0,
) -> osml_abhum_fig
osml_abhum_fig

# export figure
#ggsave(filename = "osml_abhum_fig.tiff",
 #      plot = osml_abhum_fig,
  #     path = "./final_figures",
   #    device = "tiff",
    #   dpi = 1200,
     #  width = 6, height = 4)

# glm
glm_osml_abshum <- lm(osmolality_mmol_kg ~ abs_humidity_g_m3_interpol,
           data = all_data_wide)
summary(glm_osml_abshum)
```

*positive* correlation...


### Osml ~ Avg. Abs. Humidity

```{r}
all_data_wide %>% 
  ggplot(data = .) + 
  geom_point(aes(x = avg_abs_humd,
                 y = osmolality_mmol_kg, 
                 ), 
             size = 1, 
             alpha = 0.6) + 
  stat_smooth(aes(x = avg_abs_humd, 
                  y = osmolality_mmol_kg), 
              formula = y ~ x, 
              method = "lm", 
              se = F, 
              color = "gray",
              size = 1.6, 
              alpha = 1 ) + 
  theme_classic() + 
  xlab("Prior Week's Average Absolute Humidity") + 
  ylab("Osmolality (mmol/kg)") + 
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 12),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 10),
        legend.text.align = 0,
)

# glm
glm_osml_avgabshum <- lm(osmolality_mmol_kg ~ avg_abs_humd,
           data = all_data_wide)
summary(glm_osml_avgabshum)
```

*positive* correlation...



### Osml ~ Rain

```{r}
all_data_wide %>% 
  ggplot(data = .) + 
  geom_point(aes(x = total_precip,
                 y = osmolality_mmol_kg, 
                 ), 
             size = 1, 
             alpha = 0.6) + 
  stat_smooth(aes(x = total_precip, 
                  y = osmolality_mmol_kg), 
              formula = y ~ x, 
              method = "lm", 
              se = F, 
              color = "gray",
              size = 1.6, 
              alpha = 1 ) + 
  theme_classic() + 
  xlab("Prior Week's Total Precipitation (inches)") + 
  ylab("Osmolality (mmol/kg)") + 
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 12),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 10),
        legend.text.align = 0,
)
```

This isn't really helpful considering how little variation in precipitation there was.

Maybe try a binary predictor of whether or not there was rain in the week prior to sampling:

```{r}
# ANOVA
osml_rain_aov <- aov(data = all_data_wide, 
                     osmolality_mmol_kg ~ prior_rain_Y_N)
TukeyHSD(osml_rain_aov)

# plot
all_data_wide %>% 
  ggplot(data = .) + 
  geom_boxplot(aes(x = prior_rain_Y_N, 
                   y = osmolality_mmol_kg, 
                   color = prior_rain_Y_N
                   ), 
               size = 1,
               alpha = 0.6) + 
  theme_classic() + 
  xlab("Whether it Rained in the Last Week") + 
  ylab("Osmolality (mmol/kg)") + 
  theme(text = element_text(color = "black", family = "sans", size = 12),
        axis.text = element_text(color = "black", family = "sans", size = 10),
        legend.text.align = 0,
        legend.position = "none"
)
```

Wow, very counter to our predictions.

But, actually, we're not after the osmolality values themselves, but whether it increases or decreases... so what if I did change in mean osmolality ~ whether or not it rained in the past week?

```{r}
# plot
osml_rain_wk %>% 
  ggplot(data = .) + 
  geom_boxplot(aes(x = prior_rain_Y_N, 
                   y = osml_change, 
                   color = prior_rain_Y_N
                   ), 
               size = 1,
               alpha = 0.6) + 
  theme_classic() + 
  xlab("Whether it Rained in the Last Week") + 
  ylab("Change in Osmolality (mmol/kg)") + 
  theme(text = element_text(color = "black", family = "sans", size = 12),
        axis.text = element_text(color = "black", family = "sans", size = 10),
        legend.text.align = 0,
        legend.position = "none"
)

# glm of change ~ inches precip
osml_precip_glm <- glm(data = osml_rain_wk, osml_change ~ total_precip)
summary(osml_precip_glm)
```

Try Linear plot again:

```{r}
osml_rain_wk %>% 
  ggplot(data = .) + 
  geom_point(aes(x = total_precip,
                 y = osml_change, 
                 ), 
             size = 1, 
             alpha = 0.6) + 
  stat_smooth(aes(x = total_precip, 
                  y = osml_change), 
              formula = y ~ x, 
              method = "lm", 
              se = F, 
              color = "gray",
              size = 1.6, 
              alpha = 1 ) + 
  theme_classic() + 
  xlab("Prior Week's Total Precipitation (inches)") + 
  ylab("Change in Osmolality (mmol/kg)") + 
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 12),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 10),
        legend.text.align = 0,
)
```



### Hct ~ Humidity

```{r}
all_data_wide %>% 
  ggplot(data = .) + 
  geom_point(aes(x = RH_percent_interpol,
                 y = hematocrit_percent, 
                 ), 
             size = 1, 
             alpha = 0.6) + 
  stat_smooth(aes(x = RH_percent_interpol, 
                  y = hematocrit_percent), 
              formula = y ~ x, 
              method = "lm", 
              se = F, 
              color = "blue",
              size = 1.6, 
              alpha = 1 ) + 
  theme_classic() + 
  xlab("Ambient Relative Humidity at Capture (%)") + 
  ylab("Hematocrit (%)") + 
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 12),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 10),
        legend.text.align = 0,
)

# glm
glm_hct_RH <- lm(hematocrit_percent ~ RH_percent_interpol,
           data = all_data_wide)
summary(glm_hct_RH)
```


### Hct ~ Temperature

as hematocrit increases ambient temp increases (nonsig)

```{r}
all_data_wide %>% 
  ggplot(data = .) + 
  geom_point(aes(x = temp_C_interpol,
                 y = hematocrit_percent, 
                 ), 
             size = 1, 
             alpha = 0.6) + 
  stat_smooth(aes(x = temp_C_interpol, 
                  y = hematocrit_percent), 
              formula = y ~ x, 
              method = "lm", 
              se = F, 
              color = "maroon",
              size = 1.6, 
              alpha = 1 ) + 
  theme_classic() + 
  xlab("Ambient Temperature at Capture (C)") + 
  ylab("Hematocrit (%)") + 
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 12),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 10),
        legend.text.align = 0,
)

# glm
glm_hct_temp <- lm(hematocrit_percent ~ temp_C_interpol,
           data = all_data_wide)
summary(glm_hct_temp)
```

### Osml ~ Temperature

- very strong positive relationship

```{r}
all_data_wide %>% 
  ggplot(data = .) + 
  geom_point(aes(x = temp_C_interpol,
                 y = osmolality_mmol_kg, 
                 ), 
             size = 1, 
             alpha = 0.4) + 
  stat_smooth(aes(x = temp_C_interpol, 
                  y = osmolality_mmol_kg), 
              formula = y ~ x, 
              method = "lm", 
              se = F, 
              color = "maroon",
              size = 1.6, 
              alpha = 1 ) + 
  theme_classic() + 
  xlab("Ambient Temperature at Capture (°C)") + 
  ylab("Osmolality (mmol / kg)") + 
  annotate("text", x = 22, y = 320, 
           label = "paste(italic(R) ^ 2, \" = 0.2952\")", 
           parse = TRUE,
           size = 6) +
  annotate("text", x = 22, y = 308, 
           label = "paste(italic(p), \" < 0.0001\")", 
           parse = TRUE,
           size = 6) +
  xlim(14, 24) +
  ylim(300,450) +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 18),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 14),
        legend.text.align = 0,
) -> osml_temp_fig
osml_temp_fig

# export figure
#ggsave(filename = "osml_temp_fig.tiff",
 #      plot = osml_temp_fig,
  #     path = "./final_figures",
   #    device = "tiff",
    #   dpi = 1200,
     #  width = 6, height = 4)

# glm
glm_osml_temp <- lm(osmolality_mmol_kg ~ temp_C_interpol,
           data = all_data_wide)
summary(glm_osml_temp)
```

### Hct ~ Individual

- not sig

```{r}
all_data_wide %>% 
  ggplot(data = .) + 
  geom_point(aes(x = individual_ID,
                 y = hematocrit_percent, 
                 ), 
             size = 1, 
             alpha = 0.6) + 
  stat_smooth(aes(x = individual_ID, 
                  y = hematocrit_percent, 
                  ), 
              formula = y ~ x, 
              method = "lm", 
              color = "gray",
              se = F, 
              size = 1.6, 
              alpha = 1 ) + 
  theme_classic() + 
  xlab("Individual Lizard") + 
  ylab("Hematocrit (%)") + 
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 12),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 10),
        legend.text.align = 0,
)

# glm
glm_hct_ID <- lm(hematocrit_percent ~ individual_ID,
           data = all_data_wide)
summary(glm_hct_ID)
```

### Osml ~ Individual

- sig relationship...

```{r}
all_data_wide %>% 
  ggplot(data = .) + 
  geom_point(aes(x = individual_ID,
                 y = osmolality_mmol_kg, 
                 ), 
             size = 1, 
             alpha = 0.6) + 
  stat_smooth(aes(x = individual_ID, 
                  y = osmolality_mmol_kg, 
                  ), 
              formula = y ~ x, 
              method = "lm", 
              color = "gray",
              se = F, 
              size = 1.6, 
              alpha = 1 ) + 
  theme_classic() + 
  xlab("Individual Lizard") + 
  ylab("Osmolality") + 
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 12),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 10),
        legend.text.align = 0,
)

# glm
glm_osml_ID <- lm(osmolality_mmol_kg ~ individual_ID,
           data = all_data_wide)
summary(glm_osml_ID)
```



## Conclusion

Hydration seems to be affected by:
- mass (NS)
- sex (NS)
- gravid/not (NS)
- sample eye (NS)
- whether or not the sample was hemolyzed (*)
- week/date of sampling!! (***)
- individual (*** but likely confounded with week/date...)
- capture temp & RH (both ***)

Hematocrit seems to be affected by:
- mass (NS)
- sex (*)
- capture temp & RH (NS)


Quick regression of individual_ID ~ date to check suspected multicollinearity:

```{r}
glm_date_ID <- lm(individual_ID ~ date,
           data = all_data_wide)
summary(glm_date_ID)
```


## What affects evaporative water loss?

Potential relationships:
- CEWL ~ date/week, 
        individual, 
        SVL, 
        mass, 
        gravidity, 
        hct, 
        osml, 
        cloacal temp, 
        ambient temp, 
        ambient RH, 
        measurement temp,
        measurement RH,
        **body region**

### CEWL ~ Body Region

figure:

```{r}
CEWL %>% 
  ggplot(data = .) + 
  geom_boxplot(aes(x = reorder(region, TEWL_g_m2h), 
                   y = TEWL_g_m2h, 
                   color = region
                   ), 
               size = 1,
               alpha = 1) +
  scale_x_discrete(labels = c("Dewlap", "Dorsum",
                              "Mite Patch", "Head", "Ventrum")) +
  theme_classic() + 
  xlab("Body Region") + 
  ylab(bquote('CEWL (g / '*m^2~h*')')) + 
  annotate("text", x = 1, y = 65, label = "a", size = 6) +
  annotate("text", x = 2, y = 62, label = "a", size = 6) +
  annotate("text", x = 3, y = 105, label = "b", size = 6) +
  annotate("text", x = 4, y = 92, label = "b", size = 6) +
  annotate("text", x = 5, y = 75, label = "b", size = 6) +
  scale_color_brewer(palette = "Set2") +
  ylim(1, 110) +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 18),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 14),
        legend.text.align = 0,
        legend.position = "none"
) -> CEWL_region_fig
CEWL_region_fig

# export figure
#ggsave(filename = "CEWL_region_fig.tiff",
 #      plot = CEWL_region_fig,
  #     path = "./final_figures",
   #    device = "tiff",
    #   dpi = 1200,
     #  width = 6, height = 4)
```


stats:

```{r}
# GLM
glm1 <- lm(TEWL_g_m2h ~ region, data = CEWL)
summary(glm1)

visreg(glm1, overlay=T)
# I really like this visualization style
```


I think that the way the GLM tests differences is not preferable. It tests how different each category is from the one reference category, rather than testing differences of each region against each other region, in a pairwise test. So, I will try an ANOVA to see if I can get those pairwise statistics.

```{r}
# one-way ANOVA
CEWL_region_aov <- aov(data = all_data_long,
                       TEWL_g_m2h ~ region)
# post-hoc pairwise analysis
TukeyHSD(CEWL_region_aov)
```

Okay, the GLM coefficients and ANOVA differences are the same, so either way should be fine, but helpful to have complete pairwise stats from ANOVA for marking the figure.



### CEWL ~ Osmolality

```{r}
all_data_long %>% 
  ggplot(data = .) + 
  geom_point(aes(x = osmolality_mmol_kg,
                 y = TEWL_g_m2h, 
                 color = region
                 ), 
             size = 1, 
             alpha = 0.6) + 
  scale_colour_manual(values = c("palegreen4", "lightblue4", 
                                 "plum4", "lightpink3", "seashell4")) +
  stat_smooth(aes(x = osmolality_mmol_kg, 
                  y = TEWL_g_m2h, 
                  color = region
                  ), 
              formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.6, 
              alpha = 1 ) + 
  theme_classic() + 
  xlab("Osmolality") + 
  ylab("CEWL") + 
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 12),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 10),
        legend.text.align = 0,
)

# glm
glm2 <- lm(TEWL_g_m2h ~ region + osmolality_mmol_kg,
           data = all_data_long)
summary(glm2)


# Facet ggplot
ggplot(aes(osmolality_mmol_kg, TEWL_g_m2h), data = all_data_long) + 
  geom_point() + 
  stat_smooth(aes(x = osmolality_mmol_kg, 
                  y = TEWL_g_m2h, 
                  color = region
                  ), 
              formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.6, 
              alpha = 1 )+
    theme_classic() + 
  xlab("Osmolality") + 
  ylab("CEWL") + 
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 12),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 10),
        legend.text.align = 0,
)+
  facet_wrap(~ region) # create a facet for each body region
```


### CEWL ~ Hematocrit

```{r}
all_data_long %>% 
  ggplot(data = .) + 
  geom_point(aes(x = hematocrit_percent,
                 y = TEWL_g_m2h, 
                 color = region
                 ), 
             size = 1, 
             alpha = 0.6) + 
  scale_colour_manual(values = c("palegreen4", "lightblue4", 
                                 "plum4", "lightpink3", "seashell4")) +
  stat_smooth(aes(x = hematocrit_percent, 
                  y = TEWL_g_m2h, 
                  color = region
                  ), 
              formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.6, 
              alpha = 1 ) + 
  theme_classic() + 
  xlab("Hematocrit") + 
  ylab("CEWL") + 
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 12),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 10),
        legend.text.align = 0,
)

# glms
# CEWL ~ region + hct
glm3 <- lm(TEWL_g_m2h ~ region + hematocrit_percent,
           data = all_data_long)
summary(glm3)
```


### CEWL ~ Cloacal Temperature

figure:

```{r}
all_data_long %>% 
  ggplot(data = .) + 
  geom_point(aes(x = cloacal_temp_C,
                 y = TEWL_g_m2h, 
                 color = region
                 ), 
             size = 1, 
             alpha = 0.4) + 
  stat_smooth(aes(x = cloacal_temp_C, 
                  y = TEWL_g_m2h, 
                  color = region
                  ), 
              formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.6, 
              alpha = 1) + 
  theme_classic() + 
  xlab("Cloacal Temperature (°C)") + 
  ylab(bquote('CEWL (g / '*m^2~h*')')) + 
  #annotate("text", x = 1, y = 65, label = "a", size = 6) +
  scale_color_brewer(palette = "Set2",
                     labels = c("Dewlap", "Dorsum", "Head",
                              "Mite Patch", "Ventrum"),
                     name = "") +
  ylim(1, 100) +
  xlim(20, 28) +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 18),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 14),
        legend.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 12),
        legend.text.align = 0,
        legend.position = c(0.9, 0.85)
  #) +
  #guides(color = guide_legend(nrow = 2, byrow = TRUE)
         ) -> CEWL_ctemp_fig
CEWL_ctemp_fig

# export figure
#ggsave(filename = "CEWL_ctemp_fig.tiff",
 #      plot = CEWL_ctemp_fig,
  #     path = "./final_figures",
   #    device = "tiff",
    #   dpi = 1200,
     #  width = 6, height = 4)
```

stats:

```{r}
# glms
# CEWL ~ region + ctemp
glm4 <- lm(TEWL_g_m2h ~ region + cloacal_temp_C,
           data = all_data_long)
summary(glm4)
```



### CEWL ~ Capture Temperature

```{r}
all_data_long %>% 
  ggplot(data = .) + 
  geom_point(aes(x = temp_C_interpol,
                 y = TEWL_g_m2h, 
                 color = region
                 ), 
             size = 1, 
             alpha = 0.6) + 
  scale_colour_manual(values = c("palegreen4", "lightblue4", 
                                 "plum4", "lightpink3", "seashell4")) +
  stat_smooth(aes(x = temp_C_interpol, 
                  y = TEWL_g_m2h, 
                  color = region
                  ), 
              formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.6, 
              alpha = 1 ) + 
  theme_classic() + 
  xlab("Ambient Temperature at Capture") + 
  ylab("CEWL") + 
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 12),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 10),
        legend.text.align = 0,
)

# glms
# CEWL ~ region + capture temp
glm7 <- lm(TEWL_g_m2h ~ region + temp_C_interpol,
           data = all_data_long)
summary(glm7)
```


### CEWL ~ Capture Humidity

```{r}
all_data_long %>% 
  ggplot(data = .) + 
  geom_point(aes(x = RH_percent_interpol,
                 y = TEWL_g_m2h, 
                 color = region
                 ), 
             size = 1, 
             alpha = 0.6) + 
  scale_colour_manual(values = c("palegreen4", "lightblue4", 
                                 "plum4", "lightpink3", "seashell4")) +
  stat_smooth(aes(x = RH_percent_interpol, 
                  y = TEWL_g_m2h, 
                  color = region
                  ), 
              formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.6, 
              alpha = 1 ) + 
  theme_classic() + 
  xlab("Ambient Relative Humidity at Capture") + 
  ylab("CEWL") + 
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 12),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 10),
        legend.text.align = 0,
)

# glms
# CEWL ~ region + capture RH
glm8 <- lm(TEWL_g_m2h ~ region + RH_percent_interpol,
           data = all_data_long)
summary(glm8)
```


### CEWL ~ Abs Humidity

```{r}
all_data_long %>% 
  ggplot(data = .) + 
  geom_jitter(aes(x = abs_humidity_g_m3_interpol,
                 y = TEWL_g_m2h, 
                 color = region
                 ), 
             size = 1, 
             alpha = 0.4) + 
  stat_smooth(aes(x = abs_humidity_g_m3_interpol, 
                  y = TEWL_g_m2h, 
                  color = region
                  ), 
              formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.6, 
              alpha = 1 ) + 
  theme_classic() + 
  xlab('Absolute Humidity at Capture (g / '*m^3~')') + 
  ylab(bquote('CEWL (g / '*m^2~h*')')) + 
  #annotate("text", x = 1, y = 65, label = "a", size = 6) +
  scale_color_brewer(palette = "Set2",
                     labels = c("Dewlap", "Dorsum",
                              "Head", "Mite Patch", "Ventrum"),
                     name = "") +
  ylim(1, 100) +
  xlim(8, 12) +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 18),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 14),
        legend.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 12),
        legend.text.align = 0,
        legend.position = c(0.15, 0.85)
         ) -> CEWL_abshum_fig
CEWL_abshum_fig

# export figure
#ggsave(filename = "CEWL_abshum_fig.tiff",
 #      plot = CEWL_abshum_fig,
  #     path = "./final_figures",
   #    device = "tiff",
    #   dpi = 1200,
     #  width = 6, height = 4)
```



### CEWL ~ Measurement Temperature

```{r}
all_data_long %>% 
  ggplot(data = .) + 
  geom_point(aes(x = ambient_temp_C,
                 y = TEWL_g_m2h, 
                 color = region
                 ), 
             size = 1, 
             alpha = 0.6) + 
  scale_colour_manual(values = c("palegreen4", "lightblue4", 
                                 "plum4", "lightpink3", "seashell4")) +
  stat_smooth(aes(x = ambient_temp_C, 
                  y = TEWL_g_m2h, 
                  color = region
                  ), 
              formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.6, 
              alpha = 1 ) + 
  theme_classic() + 
  xlab("Ambient Temperature During Measurement") + 
  ylab("CEWL") + 
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 12),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 10),
        legend.text.align = 0,
)

# glm
# CEWL ~ region + aquaflux measurement temp
glm9 <- lm(TEWL_g_m2h ~ region + ambient_temp_C,
           data = all_data_long)
summary(glm9)
```


### CEWL ~ Measurement Humidity

Very interesting relationship! Mite patch CEWL decreases as ambient humidity increases, but every other location appears to increase. In this case, an interaction term is warranted.

```{r}
all_data_long %>% 
  ggplot(data = .) + 
  geom_point(aes(x = ambient_RH_percent,
                 y = TEWL_g_m2h, 
                 color = region
                 ), 
             size = 1, 
             alpha = 0.6) + 
  scale_colour_manual(values = c("palegreen4", "lightblue4", 
                                 "plum4", "lightpink3", "seashell4")) +
  stat_smooth(aes(x = ambient_RH_percent, 
                  y = TEWL_g_m2h, 
                  color = region
                  ), 
              formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.6, 
              alpha = 1 ) + 
  theme_classic() + 
  xlab("Ambient Relative Humidity During Measurement") + 
  ylab("CEWL") + 
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 12),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 10),
        legend.text.align = 0,
)

# glm
# CEWL ~ region + aquaflux measurement RH
glm9 <- lm(TEWL_g_m2h ~ region*ambient_RH_percent,
           data = all_data_long)
summary(glm9)
```

### CEWL ~ Wind Speed

```{r}
all_data_long %>% 
  ggplot(data = .) + 
  geom_point(aes(x = Wind_mph_interpol,
                 y = TEWL_g_m2h, 
                 color = region
                 ), 
             size = 1, 
             alpha = 0.6) + 
  scale_colour_manual(values = c("palegreen4", "lightblue4", 
                                 "plum4", "lightpink3", "seashell4")) +
  stat_smooth(aes(x = Wind_mph_interpol, 
                  y = TEWL_g_m2h, 
                  color = region
                  ), 
              formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.6, 
              alpha = 1 ) + 
  theme_classic() + 
  xlab("Average Windspeed During Measurement") + 
  ylab("CEWL") + 
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 12),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 10),
        legend.text.align = 0,
)

# glm
# CEWL ~ region + aquaflux measurement RH
glm10 <- lm(TEWL_g_m2h ~ region + Wind_mph_interpol,
           data = all_data_long)
summary(glm10)
```

### CEWL ~ Solar Rad

- Definitely could have an effect may be worth testing in the model

```{r}
all_data_long %>% 
  ggplot(data = .) + 
  geom_point(aes(x = Solar_rad_Wm2_interpol,
                 y = TEWL_g_m2h, 
                 color = region
                 ), 
             size = 1, 
             alpha = 0.6) + 
  scale_colour_manual(values = c("palegreen4", "lightblue4", 
                                 "plum4", "lightpink3", "seashell4")) +
  stat_smooth(aes(x = Solar_rad_Wm2_interpol, 
                  y = TEWL_g_m2h, 
                  color = region
                  ), 
              formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.6, 
              alpha = 1 ) + 
  theme_classic() + 
  xlab("Solar Radiation W/m^2") + 
  ylab("CEWL") + 
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 12),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 10),
        legend.text.align = 0,
)

# glm
# CEWL ~ region + aquaflux measurement RH
glm11 <- lm(TEWL_g_m2h ~ region + Solar_rad_Wm2_interpol,
           data = all_data_long)
summary(glm11)
```


### CEWL ~ Individual

```{r}
all_data_long %>% 
  ggplot(data = .) + 
  geom_point(aes(x = individual_ID,
                 y = TEWL_g_m2h, 
                 color = region
                 ), 
             size = 1, 
             alpha = 0.6) + 
  scale_colour_manual(values = c("palegreen4", "lightblue4", 
                                 "plum4", "lightpink3", "seashell4")) +
  stat_smooth(aes(x = individual_ID, 
                  y = TEWL_g_m2h, 
                  color = region
                  ), 
              formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.6, 
              alpha = 1 ) + 
  theme_classic() + 
  xlab("Individual Lizard") + 
  ylab("CEWL") + 
  
  # just to get a better look
  # ylim(5, 40) +
  
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 12),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 10),
        legend.text.align = 0,
)

# glm
glm6 <- lm(TEWL_g_m2h ~ region + individual_ID,
           data = all_data_long)
summary(glm6)
```

### CEWL ~ SVL

```{r}
all_data_long %>% 
  ggplot(data = .) + 
  geom_point(aes(x = SVL_mm,
                 y = TEWL_g_m2h, 
                 color = region
                 ), 
             size = 1, 
             alpha = 0.6) + 
  scale_colour_manual(values = c("palegreen4", "lightblue4", 
                                 "plum4", "lightpink3", "seashell4")) +
  stat_smooth(aes(x = SVL_mm, 
                  y = TEWL_g_m2h, 
                  color = region
                  ), 
              formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.6, 
              alpha = 1 ) + 
  theme_classic() + 
  xlab("SVL") + 
  ylab("CEWL") + 
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 12),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 10),
        legend.text.align = 0,
)

# glm
glm10 <- lm(TEWL_g_m2h ~ region + SVL_mm,
           data = all_data_long)
summary(glm10)
```

### CEWL ~ Mass

Head has an opposite trend from all the other body regions, so we need an interaction term.

```{r}
all_data_long %>% 
  ggplot(data = .) + 
  geom_point(aes(x = mass_g,
                 y = TEWL_g_m2h, 
                 color = region
                 ), 
             size = 1, 
             alpha = 0.4) + 
  #scale_colour_manual(values = c("palegreen4", "lightblue4", 
   #                              "plum4", "lightpink3", "seashell4")) +
  stat_smooth(aes(x = mass_g, 
                  y = TEWL_g_m2h, 
                  color = region
                  ), 
              formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.6, 
              alpha = 1 ) + 
  theme_classic() + 
  xlab("Mass (g)") + 
  ylab(bquote('CEWL (g / '*m^2~h*')')) + 
  #annotate("text", x = 1, y = 65, label = "a", size = 6) +
  scale_color_brewer(palette = "Set2",
                     labels = c("Dewlap", "Dorsum",
                              "Head", "Mite Patch", "Ventrum"),
                     name = "") +
  ylim(1, 100) +
  xlim(2, 16) +
  scale_x_continuous(breaks = c(seq(2, 16, by = 2))) +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 18),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 14),
        legend.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 12),
        legend.text.align = 0,
        legend.position = c(0.15, 0.85)
         ) -> CEWL_mass_fig
CEWL_mass_fig

# export figure
#ggsave(filename = "CEWL_mass_fig.tiff",
 #      plot = CEWL_mass_fig,
  #     path = "./final_figures",
   #    device = "tiff",
    #   dpi = 1200,
     #  width = 6, height = 4)


# glm
glm11 <- lm(TEWL_g_m2h ~ region*mass_g,
           data = all_data_long)
summary(glm11)
```

### CEWL ~ Sex

```{r}
all_data_long %>% 
  ggplot(data = .) + 
  geom_boxplot(aes(x = sex_M_F, 
                   y = TEWL_g_m2h, 
                   color = sex_M_F
                   ), 
               size = 1,
               alpha = 0.6) + 
  facet_wrap(~region) +
  scale_color_manual(values = c("royalblue1", "mediumorchid")) +
  scale_x_discrete(breaks = c(1,2,3)) +
  theme_classic() + 
  xlab("Sex") + 
  ylab("CEWL") + 
  theme(text = element_text(color = "black", family = "sans", size = 12),
        axis.text = element_text(color = "black", family = "sans", size = 10),
        legend.text.align = 0,
        legend.position = "none"
)

# glm
glm5 <- lm(TEWL_g_m2h ~ region + sex_M_F, 
           data = all_data_long)
summary(glm5)
```

### CEWL ~ Gravidity

```{r}
all_data_long %>% 
  dplyr::filter(sex_M_F == "F") %>%
  ggplot(data = .) + 
  geom_boxplot(aes(x = gravid_Y_N, 
                   y = TEWL_g_m2h, 
                   color = gravid_Y_N
                   ), 
               size = 1,
               alpha = 0.6) + 
  facet_wrap(~region) +
  scale_color_manual(values = c("royalblue1", "mediumorchid")) +
  scale_x_discrete(breaks = c(1,2,3)) +
  theme_classic() + 
  xlab("Female Gravid or Not") + 
  ylab("CEWL") + 
  theme(text = element_text(color = "black", family = "sans", size = 12),
        axis.text = element_text(color = "black", family = "sans", size = 10),
        legend.text.align = 0,
        legend.position = "none"
)

# glm
glm5 <- lm(TEWL_g_m2h ~ region + gravid_Y_N, 
           data = all_data_long)
summary(glm5)
```


### CEWL ~ Week

```{r}
CEWL %>% 
  ggplot(data = .) + 
  geom_boxplot(aes(x = as.factor(date), 
                   y = TEWL_g_m2h, 
                   color = as.factor(date)
                   ), 
               size = 1,
               alpha = 0.6) + 
  facet_wrap(~region) + # could not figure out how to change facet labels without changing underlying data
  scale_color_manual(values = c("royalblue1", "mediumorchid", "seagreen4",
                                "royalblue1", "mediumorchid", "seagreen4")) +
  scale_x_discrete(breaks = c(1,2,3)) +
  theme_classic() + 
  xlab("Date") + 
  ylab("CEWL") + 
  theme(text = element_text(color = "black", family = "sans", size = 12),
        axis.text = element_text(color = "black", family = "sans", size = 10),
        legend.text.align = 0,
        legend.position = "none"
)

# glm
glm12 <- lm(TEWL_g_m2h ~ region + date,
           data = all_data_long)
summary(glm12)
```


### CEWL ~ holding time

```{r}
all_data_long %>% 
  ggplot(data = .) + 
  geom_point(aes(x = hold_time,
                 y = TEWL_g_m2h, 
                 color = region
                 ), 
             size = 1, 
             alpha = 0.6) + 
  scale_colour_manual(values = c("palegreen4", "lightblue4", 
                                 "plum4", "lightpink3", "seashell4")) +
  stat_smooth(aes(x = hold_time, 
                  y = TEWL_g_m2h, 
                  color = region
                  ), 
              formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.6, 
              alpha = 1 ) + 
  theme_classic() + 
  xlab("Holding Time (minutes)") + 
  ylab("CEWL (g/m^2/hr)") + 
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 12),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 10),
        legend.text.align = 0,
)

htime_CEWL_glm <- glm(data = all_data_long, TEWL_g_m2h ~ hold_time + region)
summary(htime_CEWL_glm)
```

Holding time is still significant, even after regional differences are accounted for. 


## Conclusion

CEWL is/is not affected by:
- body region - significant!
- osmolality (hydration) - not significant
- hematocrit (health) - not significant 
- cloacal temperature at measurement - sig!
- capture temp - sig!
- capture RH - sig! but we will use absolute humidity since it's decoupled from temperature
- capture wind speed and solar radiation - sig!
- measurement temperature and humidity - nonsig
- individual ID - nonsig
- mass & SVL - both sig!
- sex & gravidity - nonsig
- week/date - significant!
- hold time - significant!


# LMMs

## Hydration

Based on the simple linear models and figures above, osmolality should be predicted by date/week, individual, capture temperature, and capture RH.

### Multicollinearity

First, check for multicollinearity among independent variables:

```{r}
all_data_wide %>% 
  # select variables of interest
  dplyr::select(date,
                individual_ID,
                temp_C_interpol,
                RH_percent_interpol
                ) %>% 
  # multicollinearity plot
  pairs(.)

# also make another plot with r-sq values
# date variable doesn't work for this because not continuous numeric
all_data_wide %>% 
  # select variables of interest
  dplyr::select(individual_ID,
                temp_C_interpol,
                RH_percent_interpol,
                abs_humidity_g_m3_interpol
                ) %>% 
  # multicollinearity plot
  chart.Correlation(., histogram = F, pch = 19)
```

Date and individual_ID are collinear, as are capture temperature and RH. Individual_ID is significantly correlated with capture RH, but the r-squared is relatively low, so I think it's okay to keep both. 

In conclusion, individual_ID *or* date and capture temperature *or* RH should be used in the model. Capture temperature and absolute humidity are not too collinear.

Prep dataframe for computing models:

```{r}
hydrat_mod_dat <- all_data_wide %>%
  dplyr::select(date, 
                individual_ID,
                osmolality_mmol_kg,
                temp_C_interpol,
                RH_percent_interpol,
                abs_humidity_g_m3_interpol
                ) %>%
  dplyr::filter(complete.cases(.))
```

### Models

```{r, hydration models}
# model 1: osml ~ date + temp
# AIC = 1319.6
hydrat_mod1 <- glm(data = hydrat_mod_dat,
                         osmolality_mmol_kg ~ date + temp_C_interpol) 
summary(hydrat_mod1)

# model 2: osml ~ date + RH
# AIC = 1298.2
hydrat_mod2 <- glm(data = hydrat_mod_dat,
                         osmolality_mmol_kg ~ date + RH_percent_interpol) 
summary(hydrat_mod2)

# model 3: osml ~ individual (fixed) + temp
# AIC = 1321.3
hydrat_mod3 <- glm(data = hydrat_mod_dat,
                         osmolality_mmol_kg ~ individual_ID + temp_C_interpol) 
summary(hydrat_mod3)

# model 4: osml ~ individual (fixed) + RH
# AIC = 1305.6
hydrat_mod4 <- glm(data = hydrat_mod_dat,
                         osmolality_mmol_kg ~ individual_ID + RH_percent_interpol) 
summary(hydrat_mod4)

# model 5: osml ~ individual (random) + temp
# AIC = 1217.8 ** tied for best model
hydrat_mod5 <- nlme::lme(data = hydrat_mod_dat,
                         osmolality_mmol_kg ~ temp_C_interpol, random = ~1|individual_ID) 
summary(hydrat_mod5)

# model 6: osml ~ individual (random) + RH
# AIC = 1246.9
hydrat_mod6 <- nlme::lme(data = hydrat_mod_dat,
                         osmolality_mmol_kg ~ RH_percent_interpol, random = ~1|individual_ID) 
summary(hydrat_mod6)

# model 7: osml ~ individual (random) + RH*temp interaction
# AIC = 1217.09	** tied for best model
hydrat_mod7 <- nlme::lme(data = hydrat_mod_dat,
                         osmolality_mmol_kg ~ RH_percent_interpol * temp_C_interpol, random = ~1|individual_ID) 
summary(hydrat_mod7)
```


The best model to predict hydration is based on ambient temperature at capture as a fixed effect and individual_ID as a random effect (hydrat_mod5). Using the interaction between RH * temperature gives just as good a model (hydrat_mod7). Both have AIC of 1217. 


### Selection

I should try to drop terms and see if that improves the models at all. Model 7 includes the variables from model 5, so I'll drop terms from model 7.

```{r}
# without temperature
hydrat_mod7_step1 <- nlme::lme(data = hydrat_mod_dat,
                         osmolality_mmol_kg ~ RH_percent_interpol * temp_C_interpol - temp_C_interpol, random = ~1|individual_ID) 
summary(hydrat_mod7_step1)

# compare to with
anova(hydrat_mod7, hydrat_mod7_step1)
```

Deleting temperature is not an improvement, AIC is much higher and the model is significantly worse.

```{r}
# without RH
hydrat_mod7_step2 <- nlme::lme(data = hydrat_mod_dat,
                         osmolality_mmol_kg ~ RH_percent_interpol * temp_C_interpol - RH_percent_interpol, random = ~1|individual_ID) 
summary(hydrat_mod7_step2)

# compare to with
anova(hydrat_mod7, hydrat_mod7_step2)
```

Deleting RH is also not an improvement, AIC is much higher and the model is significantly worse without it.

I would conclude that the two best models are best in their fullest version.

However, we realized that absolute humidity would be better to use since it's decoupled from temperature, unlike relative humidity.

This does not affect hydration model 5m but we can try replacing absolute humidity for relative humidity in model 7:

```{r}
hydrat_mod7_step3 <- nlme::lme(data = hydrat_mod_dat,
                         osmolality_mmol_kg ~ abs_humidity_g_m3_interpol * temp_C_interpol, random = ~1|individual_ID) 
summary(hydrat_mod7_step3)
```

This greatly improved the model! Absolute humidity is much better than relative humidity to incorporate into the model.


### Best Models

Now save both of the best two models.

```{r}
# save step 6 summary object
osml_best_mod1 <- summary(hydrat_mod5)
# extract stats table from summary object
osml_best_mod1_vals <- data.frame(osml_best_mod1$tTable)
# export 
write.csv(osml_best_mod1_vals, "osml_best_mod1_vals.csv")

# save step 9 summary object
osml_best_mod2 <- summary(hydrat_mod7_step3)
# extract stats table from summary object
osml_best_mod2_vals <- data.frame(osml_best_mod2$tTable)
# export 
write.csv(osml_best_mod2_vals, "osml_best_mod2_vals.csv")
```


### Check LM Assumptions (Hydration Model 5 (Best #1))

Linearity and Equal Variance

Is the function **linear**? Is there **equal** variance of the residuals? The residuals should be homoskedactic relative to y_hat (or x). We don't care if there is a relationship between the residuals ~ dependent variable (actual y).

Plotting residuals shows us whether the data meets linearity and equal variance assumptions:

```{r}
# calculate residuals
qqnorm((hydrat_mod5), ~resid(.))

res_hydrat_mod5 <- all_data_wide %>%
  mutate(y_hat = 245.212600 + 6.470447*temp_C_interpol,
         e = osmolality_mmol_kg - y_hat
         )

# plot
plot(hydrat_mod5)
ggplot(data = res_hydrat_mod5, aes(x = y_hat, y = e)) +
  geom_point() + 
  theme_classic() + 
  xlab("predicted y (y-hat)") +
  ylab("residuals (e)") +
  ggtitle("Hydration Model 5") +
  geom_hline(yintercept = 0)
```

It doesn't look like there's a clear linearity violation because there isn't a shape/pattern to the residuals, there is a hint of unequal variance here. The rightmost grouping of residuals has a smaller range than the rest, but the problem is not that severe, so we'll let this go.

In this case, temperature is the only predictor variable, so we don't need o plot its residual again. Instead, we'll plot the residuals against variables not included in the model to look for any explanatory trends that are missing.

```{r}
# abs hum - might be it
ggplot(data = res_hydrat_mod5, aes(x = abs_humidity_g_m3_interpol, y = e)) +
  geom_point() + 
  theme_classic() + 
  xlab("absolute humidity (missing x?)") +
  ylab("residuals (e)") +
  ggtitle("Hydration Model 5 Residuals") +
  geom_hline(yintercept = 0)

# date - clear trend
ggplot(data = res_hydrat_mod5, aes(x = as.factor(date), y = e)) +
  geom_point() + 
  theme_classic() + 
  xlab("date (missing x?)") +
  ylab("residuals (e)") +
  ggtitle("Hydration Model 5 Residuals") +
  geom_hline(yintercept = 0)

# solar radiation - probably not it
ggplot(data = res_hydrat_mod5, aes(x = Solar_rad_Wm2_interpol, y = e)) +
  geom_point() + 
  theme_classic() + 
  xlab("solar radiation (missing x?)") +
  ylab("residuals (e)") +
  ggtitle("Hydration Model 5 Residuals") +
  geom_hline(yintercept = 0)

# rain or not - not a huge difference
ggplot(data = res_hydrat_mod5, aes(x = as.factor(prior_rain_Y_N), y = e)) +
  geom_point() + 
  theme_classic() + 
  xlab("rain (missing x?)") +
  ylab("residuals (e)") +
  ggtitle("Hydration Model 5 Residuals") +
  geom_hline(yintercept = 0)

# hct - nope
ggplot(data = res_hydrat_mod5, aes(x = hematocrit_percent, y = e)) +
  geom_point() + 
  theme_classic() + 
  xlab("hematocrit (missing x?)") +
  ylab("residuals (e)") +
  ggtitle("Hydration Model 5 Residuals") +
  geom_hline(yintercept = 0)

# sex - nope
ggplot(data = res_hydrat_mod5, aes(x = as.factor(sex_M_F), y = e)) +
  geom_point() + 
  theme_classic() + 
  xlab("sex (missing x?)") +
  ylab("residuals (e)") +
  ggtitle("Hydration Model 5 Residuals") +
  geom_hline(yintercept = 0)

# mass - definitely not
ggplot(data = res_hydrat_mod5, aes(x = mass_g, y = e)) +
  geom_point() + 
  theme_classic() + 
  xlab("mass (missing x?)") +
  ylab("residuals (e)") +
  ggtitle("Hydration Model 5 Residuals") +
  geom_hline(yintercept = 0)

# SVL - unequal variance but no clear trend
ggplot(data = res_hydrat_mod5, aes(x = SVL_mm, y = e)) +
  geom_point() + 
  theme_classic() + 
  xlab("SVL (missing x?)") +
  ylab("residuals (e)") +
  ggtitle("Hydration Model 5 Residuals") +
  geom_hline(yintercept = 0)

# individual ID - included as a random effect in the model 
# but not used to calculate residuals
ggplot(data = res_hydrat_mod5, aes(x = individual_ID, y = e)) +
  geom_point() + 
  theme_classic() + 
  xlab("lizard ID") +
  ylab("residuals (e)") +
  ggtitle("Hydration Model 5 Residuals") +
  geom_hline(yintercept = 0)
```


Brown-Forsythe test to statistically check equal variance:

H0: normally distributed (non-sig test is GOOD)
HA: NOT normally distributed (reject nul == assumption not satisfied)

```{r}
# need to create the right data & format first
bf_data <- res_hydrat_mod5 %>%
  dplyr::filter(complete.cases(temp_C_interpol)) %>%
  dplyr::mutate(middle = median(temp_C_interpol),
                side = temp_C_interpol > middle)
bf_data$side <- as.factor(bf_data$side)

# now run test
bf.test(formula = e ~ side, # y~x
        data = bf_data, # dataframe
        alpha = 0.05, # default 0.05
        na.rm = TRUE, # remove missing data before running?
        verbose = TRUE # print output to console?
        )
```

Equal variance is satisfied.


Now check normality. Is the distribution of residuals **normal**?

use Shapiro-Wilk normality test:
H0: data is NOT significantly different from normal distribution
HA: data IS significantly different from normal distribution

```{r}
simple.eda(res_hydrat_mod5$e)
shapiro.test(res_hydrat_mod5$e)
```


### Check LM Assumptions (Hydration Model 7 (Step 3))

Linearity and Equal Variance

Is the function **linear**? Is there **equal** variance of the residuals? The residuals should be homoskedactic relative to y_hat (or x). We don't care if there is a relationship between the residuals ~ dependent variable (actual y).

Plotting residuals shows us whether the data meets linearity and equal variance assumptions:

```{r}
# calculate residuals
qqnorm((hydrat_mod7_step3), ~resid(.))

res_hydrat_mod7.3 <- all_data_wide %>%
  mutate(y_hat = -646.060049 + 
           86.119252*abs_humidity_g_m3_interpol +
           53.378021*temp_C_interpol -
           4.523101*abs_humidity_g_m3_interpol*temp_C_interpol,
         e = osmolality_mmol_kg - y_hat
         )

# plot
plot(hydrat_mod7_step3)
ggplot(data = res_hydrat_mod7.3, aes(x = y_hat, y = e)) +
  geom_point() + 
  theme_classic() + 
  xlab("predicted y (y-hat)") +
  ylab("residuals (e)") +
  ggtitle("Hydration Model 7.3") +
  geom_hline(yintercept = 0)
```

It doesn't look like there's a clear linearity violation, but there is a sort of negative trendline...

Also plot the residuals ~ each predictor. In this case, region, cloacal temperature, and mass.

```{r}
# abs hum
ggplot(data = res_hydrat_mod7.3, 
       aes(x = abs_humidity_g_m3_interpol, y = e)) +
  geom_point() + 
  theme_classic() + 
  xlab("absolute humidity (x)") +
  ylab("residuals (e)") +
  ggtitle("Hydration Model 7.3 Residuals") +
  geom_hline(yintercept = 0)

# temp
ggplot(data = res_hydrat_mod7.3, 
       aes(x = temp_C_interpol, y = e)) +
  geom_point() + 
  theme_classic() + 
  xlab("temperature (x)") +
  ylab("residuals (e)") +
  ggtitle("Hydration Model 7.3 Residuals") +
  geom_hline(yintercept = 0)

# interaction?
ggplot(data = res_hydrat_mod7.3, 
       aes(x = temp_C_interpol*abs_humidity_g_m3_interpol, y = e)) +
  geom_point() + 
  theme_classic() + 
  xlab("temperature*abs-humidity (x)") +
  ylab("residuals (e)") +
  ggtitle("Hydration Model 7.3 Residuals") +
  geom_hline(yintercept = 0)
```


Finally, plot the residuals against variables not included in the model to look for any explanatory trends that are missing.

```{r}
# date - clear trend
ggplot(data = res_hydrat_mod7.3, aes(x = as.factor(date), y = e)) +
  geom_point() + 
  theme_classic() + 
  xlab("date (missing x?)") +
  ylab("residuals (e)") +
  ggtitle("Hydration Model 7.3 Residuals") +
  geom_hline(yintercept = 0)

# solar radiation - probably not it
ggplot(data = res_hydrat_mod7.3, aes(x = Solar_rad_Wm2_interpol, y = e)) +
  geom_point() + 
  theme_classic() + 
  xlab("solar radiation (missing x?)") +
  ylab("residuals (e)") +
  ggtitle("Hydration Model 7.3 Residuals") +
  geom_hline(yintercept = 0)

# rain or not - probably not
ggplot(data = res_hydrat_mod7.3, 
       aes(x = as.factor(prior_rain_Y_N), y = e)) +
  geom_point() + 
  theme_classic() + 
  xlab("rain (missing x?)") +
  ylab("residuals (e)") +
  ggtitle("Hydration Model 7.3 Residuals") +
  geom_hline(yintercept = 0)

# hct - nope
ggplot(data = res_hydrat_mod7.3, aes(x = hematocrit_percent, y = e)) +
  geom_point() + 
  theme_classic() + 
  xlab("hematocrit (missing x?)") +
  ylab("residuals (e)") +
  ggtitle("Hydration Model 7.3 Residuals") +
  geom_hline(yintercept = 0)

# sex - nope
ggplot(data = res_hydrat_mod7.3, aes(x = as.factor(sex_M_F), y = e)) +
  geom_point() + 
  theme_classic() + 
  xlab("sex (missing x?)") +
  ylab("residuals (e)") +
  ggtitle("Hydration Model 7.3 Residuals") +
  geom_hline(yintercept = 0)

# mass - definitely not
ggplot(data = res_hydrat_mod7.3, aes(x = mass_g, y = e)) +
  geom_point() + 
  theme_classic() + 
  xlab("mass (missing x?)") +
  ylab("residuals (e)") +
  ggtitle("Hydration Model 7.3 Residuals") +
  geom_hline(yintercept = 0)

# SVL - unequal variance but no clear trend
ggplot(data = res_hydrat_mod7.3, aes(x = SVL_mm, y = e)) +
  geom_point() + 
  theme_classic() + 
  xlab("SVL (missing x?)") +
  ylab("residuals (e)") +
  ggtitle("Hydration Model 7.3 Residuals") +
  geom_hline(yintercept = 0)

# individual ID
# individual ID - included as a random effect in the model 
# but not used to calculate residuals
ggplot(data = res_hydrat_mod7.3, aes(x = individual_ID, y = e)) +
  geom_point() + 
  theme_classic() + 
  xlab("lizard ID") +
  ylab("residuals (e)") +
  ggtitle("Hydration Model 7.3 Residuals") +
  geom_hline(yintercept = 0)
```


Brown-Forsythe test to statistically check equal variance:

H0: normally distributed (non-sig test is GOOD)
HA: NOT normally distributed (reject nul == assumption not satisfied)

```{r}
# need to create the right data & format first
bf_data <- res_hydrat_mod7.3 %>%
  dplyr::filter(complete.cases(temp_C_interpol, 
                               abs_humidity_g_m3_interpol)) %>%
  dplyr::mutate(middle_temp = median(temp_C_interpol),
                side_temp = as.factor(temp_C_interpol > middle_temp),
                middle_hum = median(abs_humidity_g_m3_interpol),
                side_hum = as.factor(abs_humidity_g_m3_interpol > middle_hum))

# now run test
bf.test(formula = e ~ side_temp, # y~x
        data = bf_data, # dataframe
        alpha = 0.05, # default 0.05
        na.rm = TRUE, # remove missing data before running?
        verbose = TRUE # print output to console?
        )
# now run test
bf.test(formula = e ~ side_hum, # y~x
        data = bf_data, # dataframe
        alpha = 0.05, # default 0.05
        na.rm = TRUE, # remove missing data before running?
        verbose = TRUE # print output to console?
        )
```

Equal variance *is* satisfied for both humidity and temperature.


Now check normality. Is the distribution of residuals **normal**?

use Shapiro-Wilk normality test:
H0: data is NOT significantly different from normal distribution
HA: data IS significantly different from normal distribution

```{r}
simple.eda(res_hydrat_mod7.3$e)
shapiro.test(res_hydrat_mod7.3$e)
```

Residuals are normally distributed!


### Transformations 

Do we need to transform the variables in the two best hydration models?

Model 5:
- response variable normally distributed
- predictor variable not normally distributed (multimodal, not skewed)
- linearity not obviously violated
- equal variance satisfied (Brown-Forsythe not significant)
- normality satisfied (residuals normally distributed)

Model 7.3:
- response variable normally distributed
- predictor variable 1 not normally distributed (multimodal, not skewed)
- predictor variable 2 not normally distributed (multimodal and skewed)
- linearity might be violated?
- equal variance for predictor variable 1 satisfied (Brown-Forsythe not significant)
- equal variance for predictor variable 2 satisfied (Brown-Forsythe not significant)
- normality satisfied (residuals normally distributed)

### Conclusion



## CEWL

Based on the simple linear models and figures above, CEWL should be predicted by:
- body region
- hydration (osmolality)
- cloacal temperature at measurement
- capture temperature and RH
- ambient temperature at measurement
- individual
- mass & SVL
- date/week


Prep dataframe for models:

```{r}
CEWL_mod_dat <- all_data_long %>% 
  # select variables of interest
  dplyr::select(date,
                #hold_time,
                individual_ID,
                mass_g,
                SVL_mm,
                osmolality_mmol_kg,
                TEWL_g_m2h,
                region,
                cloacal_temp_C,
                temp_C_interpol,
                RH_percent_interpol,
                abs_humidity_g_m3_interpol,
                Wind_mph_interpol,
                Solar_rad_Wm2_interpol,
                ambient_temp_C,
                ambient_RH_percent,
                abs_humidity_g_m3
                ) %>%
  dplyr::filter(complete.cases(.))
```


### Multicollinearity

Check for multicollinearity among independent variables:

```{r}
CEWL_mod_dat %>% 
  # get rid of dependent variable
  dplyr::select(-TEWL_g_m2h) %>%
  # multicollinearity plot
  pairs(.)

# also make another plot with r-sq values
# non-numeric variables don't work for this
CEWL_mod_dat %>% 
  # select variables of interest
  dplyr::select(-TEWL_g_m2h, -date, -region) %>% 
  # multicollinearity plot
  chart.Correlation(., histogram = F, pch = 19)
```

collinear variables that should not be used in combination:
- mass and SVL
- temperature and RH at capture (same from hydration multicollinearity)
- date and individual_ID
- the various measures of humidity


### Models

```{r}
# model 1
# AIC = 5175.665
CEWL_mod1 <- nlme::lme(data = CEWL_mod_dat,
                         TEWL_g_m2h ~ region + osmolality_mmol_kg +
                          cloacal_temp_C + ambient_temp_C +
                          RH_percent_interpol + SVL_mm, 
                          random = ~1|individual_ID) 
summary(CEWL_mod1)

# model 2
# AIC = 5171.271
CEWL_mod2 <- nlme::lme(data = CEWL_mod_dat,
                         TEWL_g_m2h ~ region + osmolality_mmol_kg +
                          cloacal_temp_C + ambient_temp_C +
                          RH_percent_interpol + mass_g, 
                          random = ~1|individual_ID) 
summary(CEWL_mod2)

# model 3
# AIC = 5166.725
CEWL_mod3 <- nlme::lme(data = CEWL_mod_dat,
                         TEWL_g_m2h ~ region + osmolality_mmol_kg +
                          cloacal_temp_C + ambient_temp_C +
                          temp_C_interpol + SVL_mm, 
                          random = ~1|individual_ID) 
summary(CEWL_mod3)

# model 4
# AIC = 5163.566 ** best model ** 
CEWL_mod4 <- nlme::lme(data = CEWL_mod_dat,
                         TEWL_g_m2h ~ region + osmolality_mmol_kg +
                          cloacal_temp_C + ambient_temp_C +
                          temp_C_interpol + mass_g, 
                          random = ~1|individual_ID) 
summary(CEWL_mod4)

# model 5
# AIC = 5208
CEWL_mod5 <- glm(data = CEWL_mod_dat,
                         TEWL_g_m2h ~ region + osmolality_mmol_kg +
                          cloacal_temp_C + ambient_temp_C +
                          temp_C_interpol + SVL_mm + date) 
summary(CEWL_mod5)

# model 6
# AIC = 5205.1
CEWL_mod6 <- glm(data = CEWL_mod_dat,
                         TEWL_g_m2h ~ region + osmolality_mmol_kg +
                          cloacal_temp_C + ambient_temp_C +
                          temp_C_interpol + mass_g + date) 
summary(CEWL_mod6)

# model 7
# AIC = 5219.7
CEWL_mod7 <- glm(data = CEWL_mod_dat,
                         TEWL_g_m2h ~ region + osmolality_mmol_kg +
                          cloacal_temp_C + ambient_temp_C +
                          RH_percent_interpol + SVL_mm + date) 
summary(CEWL_mod7)

# model 8
# AIC = 5214.3
CEWL_mod8 <- glm(data = CEWL_mod_dat,
                         TEWL_g_m2h ~ region + osmolality_mmol_kg +
                          cloacal_temp_C + ambient_temp_C +
                          RH_percent_interpol + mass_g + date) 
summary(CEWL_mod8)

# model 9 = model 4, but with RH*temp interaction
# AIC = 5164.786 ** nearly as good as best model ** 
CEWL_mod9 <- nlme::lme(data = CEWL_mod_dat,
                         TEWL_g_m2h ~ region + osmolality_mmol_kg +
                          cloacal_temp_C + ambient_temp_C +
                          temp_C_interpol*RH_percent_interpol + mass_g, 
                          random = ~1|individual_ID) 
summary(CEWL_mod9)
```

Now that I know which of the collinear variables are better to use, I can use model 9 and drop terms to simplify them as much as possible to find the simplest, best model.


### Selection

It's hard to automate model selection for a mixed-effects model, so I'll do it manually. 

Extract significance values from model 9:

```{r}
# save summary object
CEWL_mod9_sum <- summary(CEWL_mod9)
# extract stats table from summary object
CEWL_mod9_important_vals <- data.frame(CEWL_mod9_sum$tTable) %>%
  # arrange rows by most->least significant p-value
  dplyr::arrange(., p.value)
```

Osmolality, ambient temp at measurement, and capture RH and temperature can be dropped to see if the model improves. Some of the regions aren't significant, but others are, so I'll keep that variable because it's also our main variable of interest.

I can also check dropterm, but I have to use on a glm with only fixed effects:

```{r}
CEWL_mod_simple <- glm(data = CEWL_mod_dat,
                         TEWL_g_m2h ~ region + osmolality_mmol_kg +
                          cloacal_temp_C + ambient_temp_C +
                          temp_C_interpol*RH_percent_interpol + mass_g
                          + individual_ID) 
dropterm(CEWL_mod_simple)
```

It seems like only deleting osmolality and/or ambient temperature would improve the model. Neither of those deletions would result in a delta-AIC >2, but I'll still try dropping some terms from the mixed-effect model.

```{r}
# without osmolality
CEWL_mod9_step1 <- nlme::lme(data = CEWL_mod_dat,
                         TEWL_g_m2h ~ region +
                          cloacal_temp_C + ambient_temp_C +
                          temp_C_interpol*RH_percent_interpol + mass_g, 
                          random = ~1|individual_ID) 
summary(CEWL_mod9_step1)

# compare to with
anova(CEWL_mod9, CEWL_mod9_step1)
```


The model is significantly better *without* osmolality as a predictor, so leave out and try next deletion:

```{r}
# without capture temperature
CEWL_mod9_step2 <- nlme::lme(data = CEWL_mod_dat,
                         TEWL_g_m2h ~ region +
                          cloacal_temp_C + ambient_temp_C +
                          temp_C_interpol*RH_percent_interpol + mass_g -
                          temp_C_interpol, 
                          random = ~1|individual_ID) 
summary(CEWL_mod9_step2)

# compare to with
anova(CEWL_mod9_step1, CEWL_mod9_step2)
```

Model is significantly better *with* temperature predictor... try omitting RH instead:

```{r}
# without capture RH
CEWL_mod9_step3 <- nlme::lme(data = CEWL_mod_dat,
                         TEWL_g_m2h ~ region +
                          cloacal_temp_C + ambient_temp_C +
                          temp_C_interpol*RH_percent_interpol + mass_g -
                          RH_percent_interpol, 
                          random = ~1|individual_ID) 
summary(CEWL_mod9_step3)

# compare to with
anova(CEWL_mod9_step1, CEWL_mod9_step3)
```

Model is significantly better *with* capture RH predictor... try omitting ambient measurement temperature instead:

```{r}
# without measurement temperature
CEWL_mod9_step4 <- nlme::lme(data = CEWL_mod_dat,
                         TEWL_g_m2h ~ region + cloacal_temp_C + mass_g +
                          temp_C_interpol*RH_percent_interpol, 
                          random = ~1|individual_ID) 
summary(CEWL_mod9_step4)

# compare to with
anova(CEWL_mod9_step1, CEWL_mod9_step4)

# compare to omitting capture temperature
anova(CEWL_mod9_step2, CEWL_mod9_step4)
```

The delta-AIC is <2 and the difference between having measurement temperature or not is non-significant. Omitting measurement temperature is also better than omitting capture temperature, so we will drop it. 

Now, look at the difference between having cloacal temperature versus capture temperature in the model:

```{r}
# without cloacal temperature
CEWL_mod9_step5 <- nlme::lme(data = CEWL_mod_dat,
                         TEWL_g_m2h ~ region + mass_g +
                          temp_C_interpol*RH_percent_interpol, 
                          random = ~1|individual_ID) 
summary(CEWL_mod9_step5)

# compare to with
anova(CEWL_mod9_step4, CEWL_mod9_step5)

# compare to omitting capture temperature instead
CEWL_mod9_step6 <- nlme::lme(data = CEWL_mod_dat,
                         TEWL_g_m2h ~ region + mass_g + cloacal_temp_C +
                          temp_C_interpol*RH_percent_interpol -
                           temp_C_interpol, 
                          random = ~1|individual_ID) 
summary(CEWL_mod9_step6)
anova(CEWL_mod9_step6, CEWL_mod9_step5)

# what if cloacal temperature interacts with capture RH
CEWL_mod9_step7 <- nlme::lme(data = CEWL_mod_dat,
                         TEWL_g_m2h ~ region + mass_g +
                          cloacal_temp_C*RH_percent_interpol, 
                          random = ~1|individual_ID) 
summary(CEWL_mod9_step7)
anova(CEWL_mod9_step6, CEWL_mod9_step7)
anova(CEWL_mod9_step5, CEWL_mod9_step7)
```

Comparing steps 4 and 5, the model is significantly better *with* cloacal temperature. Comparing steps 5 and 6, omitting capture temperature is significantly better than omitting cloacal temperature. Finally, if we replace capture temperature with cloacal temperature in an interaction with capture RH (step 7), there's only an AIC difference of 2, so either could be fine. Steps 6 and 7 are equally good. But, looking more closely, 6 has more significant coefficients, so it would be a better choice.

Finally, see if step 6 improves if we remove RH and only keep its interaction:

```{r}
# without capture RH, interaction only
CEWL_mod9_step8 <- nlme::lme(data = CEWL_mod_dat,
                         TEWL_g_m2h ~ region + mass_g + cloacal_temp_C +
                          temp_C_interpol*RH_percent_interpol -
                           temp_C_interpol - RH_percent_interpol, 
                          random = ~1|individual_ID) 
summary(CEWL_mod9_step8)

# compare to with
anova(CEWL_mod9_step6, CEWL_mod9_step8)
```

Without RH is better, but not significantly. Now the interaction between capture temperature and RH is not a significant predictor, though, so test whether it should be removed:

```{r}
# without interaction at all
CEWL_mod9_step9 <- nlme::lme(data = CEWL_mod_dat,
                         TEWL_g_m2h ~ region + mass_g + cloacal_temp_C, 
                          random = ~1|individual_ID) 
summary(CEWL_mod9_step9)

# compare to with
anova(CEWL_mod9_step6, CEWL_mod9_step9)
anova(CEWL_mod9_step8, CEWL_mod9_step9)
```

Step 9 is significantly better than step 8, and also better than step 6 based on AIC, but not significantly, so I could choose either step 6 or step 9. Since humidity was one thing we predicted to be important, I think I would choose to keep it, even though delta-AIC was >2. 

Try adding a body region * mass interaction term based on new figure interpretation:

```{r}
# try adding region*mass interaction to step 6
CEWL_mod9_step10 <- nlme::lme(data = CEWL_mod_dat,
                         TEWL_g_m2h ~ region*mass_g + cloacal_temp_C +
                          temp_C_interpol*RH_percent_interpol -
                           temp_C_interpol, 
                          random = ~1|individual_ID) 
summary(CEWL_mod9_step10)

# compare
anova(CEWL_mod9_step6, CEWL_mod9_step10)
anova(CEWL_mod9_step9, CEWL_mod9_step10)
```

Adding the interaction term to what was step 6 made it way better than both step 6 and step 9. 

Also test if adding interaction to step 9 keeps the interaction versions of steps 6 and 9 equally good again.

```{r}
# try adding region*mass interaction to step 9
CEWL_mod9_step11 <- nlme::lme(data = CEWL_mod_dat,
                         TEWL_g_m2h ~ region*mass_g + cloacal_temp_C, 
                          random = ~1|individual_ID) 
summary(CEWL_mod9_step11)

# compare
anova(CEWL_mod9_step6, CEWL_mod9_step11)
anova(CEWL_mod9_step9, CEWL_mod9_step11)
anova(CEWL_mod9_step10, CEWL_mod9_step11)
```

Step 11 is non-significantly better than step 10, and both are significantly better than steps 6 and 9. Thus, the two best models now both include a region*mass interaction term.

Double check that dropping the individual terms outside the interactions does not improve the model:

```{r}
# remove individual region term from step 11
CEWL_mod9_step12 <- nlme::lme(data = CEWL_mod_dat,
                         TEWL_g_m2h ~ region*mass_g + cloacal_temp_C - region, 
                          random = ~1|individual_ID) 
summary(CEWL_mod9_step12)

# compare
anova(CEWL_mod9_step11, CEWL_mod9_step12)
```

That did not improve AIC, so nect try removing mass term:

```{r}
# remove individual mass term from step 11
CEWL_mod9_step13 <- nlme::lme(data = CEWL_mod_dat,
                         TEWL_g_m2h ~ region*mass_g + cloacal_temp_C - mass_g, 
                          random = ~1|individual_ID) 
summary(CEWL_mod9_step13)

# compare
anova(CEWL_mod9_step12, CEWL_mod9_step13)
```

That resulted in a significantly better model with much lower AIC, so we will leave out the individual mass term. 

Finally, also check these removals for step 10:

```{r}
# remove individual region term from step 10
CEWL_mod9_step14 <- nlme::lme(data = CEWL_mod_dat,
                         TEWL_g_m2h ~ region*mass_g + cloacal_temp_C +
                          temp_C_interpol*RH_percent_interpol -
                           temp_C_interpol - region, 
                          random = ~1|individual_ID) 
summary(CEWL_mod9_step14)

# compare
anova(CEWL_mod9_step10, CEWL_mod9_step14)
```

Removing the individual region predictor makes the model significantly worse.

Try mass:

```{r}
# remove individual mass term from step 10
CEWL_mod9_step15 <- nlme::lme(data = CEWL_mod_dat,
                         TEWL_g_m2h ~ region*mass_g + cloacal_temp_C +
                          temp_C_interpol*RH_percent_interpol -
                           temp_C_interpol - mass_g, 
                          random = ~1|individual_ID) 
summary(CEWL_mod9_step15)

# compare
anova(CEWL_mod9_step10, CEWL_mod9_step15)
```

In this case, steps 10 and 15 are equally as good as each other, with exactly the same AIC values. Since the singular mass term was a significant predictor in step 10, I think it should be kept in this version of the model. 


### Updates 

We decided that cloacal temperature should be a random effect. Step 13->16 and step 10->17 with cloacal temperature as a random effect in each now.

```{r}
# cloacal temperature as a random instead of fixed effect in step 13->16
CEWL_mod9_step16 <- nlme::lme(data = CEWL_mod_dat,
                         TEWL_g_m2h ~ region*mass_g - mass_g, 
                          random = c(~1|individual_ID, ~1|cloacal_temp_C)) 
summary(CEWL_mod9_step16)

# compare
anova(CEWL_mod9_step13, CEWL_mod9_step16)

# no cloacal temperature at all
CEWL_mod9_step17 <- nlme::lme(data = CEWL_mod_dat,
                         TEWL_g_m2h ~ region*mass_g - mass_g, 
                          random = c(~1|individual_ID)) 
summary(CEWL_mod9_step17)

# compare
anova(CEWL_mod9_step17, CEWL_mod9_step16)

# cloacal temperature as a random instead of fixed effect in step 10->18
CEWL_mod9_step18 <- nlme::lme(data = CEWL_mod_dat,
                         TEWL_g_m2h ~ region*mass_g +
                          temp_C_interpol*RH_percent_interpol -
                           temp_C_interpol, 
                          random = c(~1|individual_ID, ~1|cloacal_temp_C)) 
summary(CEWL_mod9_step18)

# compare
anova(CEWL_mod9_step10, CEWL_mod9_step18)

# no cloacal temperature at all
CEWL_mod9_step19 <- nlme::lme(data = CEWL_mod_dat,
                         TEWL_g_m2h ~ region*mass_g +
                          temp_C_interpol*RH_percent_interpol -
                           temp_C_interpol, 
                          random = ~1|individual_ID) 
summary(CEWL_mod9_step19)

# compare
anova(CEWL_mod9_step18, CEWL_mod9_step19)
```

Cloacal temperature is better as a fixed effect in both cases. It's better to omit cloacal temperature than it is to change it to a random effect. 


Steps 10 and 13 are still the best models, but we decided absolute humidity would be better than relative humidity, so we need to try that substitution for each of the best-models.

Step 10 with absolute humidity instead of RH:

```{r}
# replace RH with abs humidity
CEWL_mod9_step20 <- nlme::lme(data = CEWL_mod_dat,
                         TEWL_g_m2h ~ region*mass_g + cloacal_temp_C +
                          temp_C_interpol*abs_humidity_g_m3_interpol -
                           temp_C_interpol, 
                          random = ~1|individual_ID) 
summary(CEWL_mod9_step20)

# compare
anova(CEWL_mod9_step10, CEWL_mod9_step20)
```

Switching from relative to absolute humidity does improve the model AIC slightly!

Step 13 had no temperature or humidity variable, so it's unaffected.

We also observed a potential interaction between region*absolute humidity, so I'll try adding that to step20:

```{r}
# try a region * abs humidity interaction
CEWL_mod9_step21 <- nlme::lme(data = CEWL_mod_dat,
                         TEWL_g_m2h ~ region*mass_g + cloacal_temp_C +
                           region*abs_humidity_g_m3_interpol +
                          temp_C_interpol*abs_humidity_g_m3_interpol -
                           temp_C_interpol, 
                          random = ~1|individual_ID) 
summary(CEWL_mod9_step21)

# compare
anova(CEWL_mod9_step20, CEWL_mod9_step21)
```


*Unsure whether or not to add it...* The region*humidity interaction is significant, and with it, the model has a lower AIC, but it also makes the model much more complicated...

Try adding solar radiation:

```{r}
# try adding to step 20
CEWL_mod9_step22 <- nlme::lme(data = CEWL_mod_dat,
                         TEWL_g_m2h ~ region*mass_g + 
                           cloacal_temp_C +
                           Solar_rad_Wm2_interpol +
                           temp_C_interpol*abs_humidity_g_m3_interpol -
                           temp_C_interpol, 
                          random = ~1|individual_ID) 
summary(CEWL_mod9_step22)

# compare to without
anova(CEWL_mod9_step20, CEWL_mod9_step22)

# try adding to step 13
CEWL_mod9_step23 <- nlme::lme(data = CEWL_mod_dat,
                         TEWL_g_m2h ~ region*mass_g + 
                           cloacal_temp_C +
                           Solar_rad_Wm2_interpol, 
                          random = ~1|individual_ID) 
summary(CEWL_mod9_step23)

# compare to without
anova(CEWL_mod9_step13, CEWL_mod9_step23)
```

Solar radiation does not improve either model, go without.


Try adding wind speed:

```{r}
# try adding wind speed to step 20
CEWL_mod9_step24 <- nlme::lme(data = CEWL_mod_dat,
                         TEWL_g_m2h ~ region*mass_g + 
                           cloacal_temp_C +
                           Wind_mph_interpol +
                           temp_C_interpol*abs_humidity_g_m3_interpol -
                           temp_C_interpol, 
                          random = ~1|individual_ID) 
summary(CEWL_mod9_step24)

# compare to without
anova(CEWL_mod9_step20, CEWL_mod9_step24)

# try adding to step 13
CEWL_mod9_step25 <- nlme::lme(data = CEWL_mod_dat,
                         TEWL_g_m2h ~ region*mass_g + 
                           cloacal_temp_C +
                           Wind_mph_interpol, 
                          random = ~1|individual_ID) 
summary(CEWL_mod9_step25)

# compare to without
anova(CEWL_mod9_step13, CEWL_mod9_step25)
```

Wind speed *does* seem to significantly improve step 20, but not step 13... 


Lastly, we need to see if adding the holding time affects CEWL measures when the other important variables are already accounted for.

```{r}
# add hold time to step 20
#CEWL_mod9_step21 <- nlme::lme(data = CEWL_mod_dat,
 #                        TEWL_g_m2h ~ region*mass_g + cloacal_temp_C +
  #                         hold_time +
   #                       temp_C_interpol*abs_humidity_g_m3_interpol -
    #                       temp_C_interpol, 
     #                     random = ~1|individual_ID) 
#summary(CEWL_mod9_step21)

# compare
#anova(CEWL_mod9_step20, CEWL_mod9_step21)
```

It does *not* improve the model.

Check for step 13:

```{r}
# remove individual mass term from step 11
#CEWL_mod9_step22 <- nlme::lme(data = CEWL_mod_dat,
 #                        TEWL_g_m2h ~ region*mass_g + cloacal_temp_C -
  #                         mass_g + hold_time, 
   #                       random = ~1|individual_ID) 
#summary(CEWL_mod9_step22)

# compare
#anova(CEWL_mod9_step13, CEWL_mod9_step22)
```

It does *not* improve the model.

I commented-out the hold_time things because including it decreased the number of observations due to NA removals.


### Best Models

```{r}
# save step 24 summary object
CEWL_best_mod1 <- summary(CEWL_mod9_step24)
# extract stats table from summary object
CEWL_best_mod1_vals <- data.frame(CEWL_best_mod1$tTable)
# export 
write.csv(CEWL_best_mod1_vals, "CEWL_best_mod1_vals.csv")

# save step 13 summary object
CEWL_best_mod2 <- summary(CEWL_mod9_step13)
# extract stats table from summary object
CEWL_best_mod2_vals <- data.frame(CEWL_best_mod2$tTable)
# export 
write.csv(CEWL_best_mod2_vals, "CEWL_best_mod2_vals.csv")
```



### Check LM Assumptions (CEWL Model 13)

Linearity and Equal Variance

Is the function **linear**? Is there **equal** variance of the residuals? The residuals should be homoskedactic relative to y_hat (or x). We don't care if there is a relationship between the residuals ~ dependent variable (actual y).

Plotting residuals shows us whether the data meets linearity and equal variance assumptions:

```{r}
# calculate residuals
qqnorm((CEWL_mod9_step13), ~resid(.))

res_CEWL_mod13 <- all_data_long %>%
  mutate(y_hat = case_when(region == "dewl" ~ (2.1535856*cloacal_temp_C + 1.2316269*mass_g - 42.7468257),
                           region == "dors" ~ (2.1535856*cloacal_temp_C + 0.2054408*mass_g - 42.7468257 + 12.0823088),
                           region == "head" ~ (2.1535856*cloacal_temp_C - 0.3874094*mass_g - 42.7468257 + 24.4910799),
                           region == "mite" ~ (2.1535856*cloacal_temp_C + 1.6153809*mass_g - 42.7468257 + 2.3449933),
                           region == "vent" ~ (2.1535856*cloacal_temp_C + 1.4017840*mass_g - 42.7468257 + 8.8417357)),
         e = TEWL_g_m2h - y_hat
         )

# plot
ggplot(data = res_CEWL_mod13, aes(x = y_hat, y = e)) +
  geom_point() + 
  theme_classic() + 
  xlab("predicted y (y-hat)") +
  ylab("residuals (e)") +
  ggtitle("CEWL Model 13 Residuals") +
  geom_hline(yintercept = 0)
```

It's definitely making a fan shape. :(

Brown-Forsythe test to statistically check equal variance:

H0: normally distributed (non-sig test is GOOD)
HA: NOT normally distributed (reject nul == assumption not satisfied)

```{r}
# need to create the right data & format first
bf_data <- res_CEWL_mod13 %>%
  dplyr::filter(complete.cases(cloacal_temp_C, mass_g, TEWL_g_m2h)) %>%
  dplyr::mutate(middle_ct = median(cloacal_temp_C),
                side_ct = as.factor(cloacal_temp_C > middle_ct),
                middle_mass = median(mass_g),
                side_mass = as.factor(mass_g > middle_mass))

# now run test
bf.test(formula = e ~ side_ct, # y~x
        data = bf_data, # dataframe
        alpha = 0.05, # default 0.05
        na.rm = TRUE, # remove missing data before running?
        verbose = TRUE # print output to console?
        )
bf.test(formula = e ~ side_mass, # y~x
        data = bf_data, # dataframe
        alpha = 0.05, # default 0.05
        na.rm = TRUE, # remove missing data before running?
        verbose = TRUE # print output to console?
        )
```

Equal variance is satisfied for both continuous predictor variables.


Now check normality. Is the distribution of residuals **normal**?

use Shapiro-Wilk normality test:
H0: data is NOT significantly different from normal distribution
HA: data IS significantly different from normal distribution

```{r}
simple.eda(res_CEWL_mod13$e)
shapiro.test(res_CEWL_mod13$e)
```



### Check LM Assumptions (CEWL Model 24)

Linearity and Equal Variance

Is the function **linear**? Is there **equal** variance of the residuals? The residuals should be homoskedactic relative to y_hat (or x). We don't care if there is a relationship between the residuals ~ dependent variable (actual y).

Plotting residuals shows us whether the data meets linearity and equal variance assumptions:

```{r}
# calculate residuals
qqnorm((CEWL_mod9_step24), ~resid(.))

res_CEWL_mod9.24 <- all_data_long %>%
  mutate(y_hat = case_when(region == "dewl" ~ 
                              # cloacal temp effect
                             (1.86217364*cloacal_temp_C +
                                # mass by region interaction
                                # baseline is dewlap
                                1.19257122*mass_g -
                                # no individual mass effect
                                # wind
                                1.80572499*Wind_mph_interpol +
                                # humidity
                                1.51162151*abs_humidity_g_m3_interpol +
                                # humidity * temp interaction
                                0.01589687*temp_C_interpol*abs_humidity_g_m3_interpol
                                # intercept, baseline is dewlap
                                - 45.57047471),
                           region == "dors" ~ 
                             # cloacal temp effect
                             (1.86217364*cloacal_temp_C -
                                # mass by region interaction
                                1.02884615*mass_g + 
                                # individual mass effect
                                1.19257122*mass_g -
                                # wind
                                1.80572499*Wind_mph_interpol +
                                # humidity
                                1.51162151*abs_humidity_g_m3_interpol +
                                # humidity * temp interaction
                                0.01589687*temp_C_interpol*abs_humidity_g_m3_interpol
                                # intercept
                                - 45.57047471
                                # intercept by region
                                + 12.10482259
                                ),
                           region == "head" ~ 
                             # cloacal temp effect
                             (1.86217364*cloacal_temp_C -
                                # mass by region interaction
                                1.62053929*mass_g + 
                                # individual mass effect
                                1.19257122*mass_g -
                                # wind
                                1.80572499*Wind_mph_interpol +
                                # humidity
                                1.51162151*abs_humidity_g_m3_interpol +
                                # humidity * temp interaction
                                0.01589687*temp_C_interpol*abs_humidity_g_m3_interpol
                                # intercept
                                - 45.57047471
                                # intercept by region
                                + 24.50914963
                                ),
                           region == "mite" ~ 
                             # cloacal temp effect
                             (1.86217364*cloacal_temp_C +
                                # mass by region interaction
                                0.38728891*mass_g + 
                                # individual mass effect
                                1.19257122*mass_g -
                                # wind
                                1.80572499*Wind_mph_interpol +
                                # humidity
                                1.51162151*abs_humidity_g_m3_interpol +
                                # humidity * temp interaction
                                0.01589687*temp_C_interpol*abs_humidity_g_m3_interpol
                                # intercept
                                - 45.57047471
                                # intercept by region
                                + 2.29360864
                                ),
                           region == "vent" ~ 
                             # cloacal temp effect
                             (1.86217364*cloacal_temp_C +
                                # mass by region interaction
                                0.16222928*mass_g + 
                                # individual mass effect
                                1.19257122*mass_g -
                                # wind
                                1.80572499*Wind_mph_interpol +
                                # humidity
                                1.51162151*abs_humidity_g_m3_interpol +
                                # humidity * temp interaction
                                0.01589687*temp_C_interpol*abs_humidity_g_m3_interpol
                                # intercept
                                - 45.57047471
                                # intercept by region
                                + 8.92843246
                                )),
         e = TEWL_g_m2h - y_hat
         )

# plot
ggplot(data = res_CEWL_mod9.24, aes(x = y_hat, y = e)) +
  geom_point() + 
  theme_classic() + 
  xlab("predicted y (y-hat)") +
  ylab("residuals (e)") +
  ggtitle("Residuals Plot for CEWL Model 9.24") +
  geom_hline(yintercept = 0)
```

That is a very obvious fan shape... 


Brown-Forsythe test to statistically check equal variance:

H0: normally distributed (non-sig test is GOOD)
HA: NOT normally distributed (reject nul == assumption not satisfied)

```{r}
# need to create the right data & format first
bf_data <- res_CEWL_mod9.24 %>%
  dplyr::filter(complete.cases(cloacal_temp_C, 
                               mass_g, 
                               Wind_mph_interpol,
                               abs_humidity_g_m3_interpol,
                               temp_C_interpol,
                               TEWL_g_m2h)) %>%
  dplyr::mutate(middle_ct = median(cloacal_temp_C),
                side_ct = as.factor(cloacal_temp_C > middle_ct),
                
                middle_mass = median(mass_g),
                side_mass = as.factor(mass_g > middle_mass),
                
                middle_wind = median(Wind_mph_interpol),
                side_wind = as.factor(Wind_mph_interpol > middle_wind),
                
                middle_hum = median(abs_humidity_g_m3_interpol),
                side_hum = as.factor(abs_humidity_g_m3_interpol > middle_hum),
                
                middle_temp = median(temp_C_interpol),
                side_temp = as.factor(temp_C_interpol > middle_temp))

# now run test
bf.test(formula = e ~ side_ct, # y~x
        data = bf_data, # dataframe
        alpha = 0.05, # default 0.05
        na.rm = TRUE, # remove missing data before running?
        verbose = TRUE # print output to console?
        )
bf.test(formula = e ~ side_mass, # y~x
        data = bf_data, # dataframe
        alpha = 0.05, # default 0.05
        na.rm = TRUE, # remove missing data before running?
        verbose = TRUE # print output to console?
        )
bf.test(formula = e ~ side_wind, # y~x
        data = bf_data, # dataframe
        alpha = 0.05, # default 0.05
        na.rm = TRUE, # remove missing data before running?
        verbose = TRUE # print output to console?
        )
bf.test(formula = e ~ side_hum, # y~x
        data = bf_data, # dataframe
        alpha = 0.05, # default 0.05
        na.rm = TRUE, # remove missing data before running?
        verbose = TRUE # print output to console?
        )
bf.test(formula = e ~ side_temp, # y~x
        data = bf_data, # dataframe
        alpha = 0.05, # default 0.05
        na.rm = TRUE, # remove missing data before running?
        verbose = TRUE # print output to console?
        )
```

Equal variance is satisfied for all continuous variables.


Now check normality. Is the distribution of residuals **normal**?

use Shapiro-Wilk normality test:
H0: data is NOT significantly different from normal distribution
HA: data IS significantly different from normal distribution

```{r}
simple.eda(res_CEWL_mod9.24$e)
shapiro.test(res_CEWL_mod9.24$e)
```

Residuals are not normal... 


### Test Transformations 

Do we need to transform the variables in the two best hydration models?

CEWL Model 13:
- response variable not normally distributed
- both continuous predictor variables not normally distributed (skewed)
- linearity probably violated
- equal variance for both continuous predictor variables satisfied (Brown-Forsythe not significant)
- normality not satisfied (residuals skewed right)

CEWL Model 24:
- response variable not normally distributed
- all continuous predictor variables not normally distributed (skewed)
- linearity probably violated
- equal variance for all continuous predictor variables satisfied (Brown-Forsythe not significant)
- normality not satisfied (residuals skewed right)

Yes, I should try transforming the variables in each of these models.

I'll check if simple transformations like log or sqrt affect normality of the variables.

Add transformed values:

```{r}
CEWL_mod_dat_transf <- all_data_wide %>%
  mutate(mass_sqrt = sqrt(mass_g),
         mass_log = log(mass_g),
         
         cloacal_temp_sqrt = sqrt(cloacal_temp_C),
         cloacal_temp_log = log(cloacal_temp_C),
         
         wind_sqrt = sqrt(Wind_mph_interpol),
         wind_log = log(Wind_mph_interpol),
         
         abhum_sqrt = sqrt(abs_humidity_g_m3_interpol),
         abhum_log = log(abs_humidity_g_m3_interpol),
         
         temp_sqrt = sqrt(temp_C_interpol),
         temp_log = log(temp_C_interpol),
         
         dors_sqrt = sqrt(dorsum_TEWL_g_m2h),
         dors_log = log(dorsum_TEWL_g_m2h),
         
         dewl_sqrt = sqrt(dewlap_TEWL_g_m2h),
         dewl_log = log(dewlap_TEWL_g_m2h),
         
         head_sqrt = sqrt(head_TEWL_g_m2h),
         head_log = log(head_TEWL_g_m2h),
         
         mite_sqrt = sqrt(mitepatch_TEWL_g_m2h),
         mite_log = log(mitepatch_TEWL_g_m2h),
         
         vent_sqrt = sqrt(ventrum_TEWL_g_m2h),
         vent_log = log(ventrum_TEWL_g_m2h)
         )
```

Check whether that helped any of the independent variables:

```{r}
# sqrt(mass)
CEWL_mod_dat_transf %>%
  ggplot(., aes(x = mass_sqrt)) +
  geom_histogram(color = "black", fill="steelblue", bins=50) + 
  theme_classic() +
  xlab("sqrt(mass)") + 
  ylab("Count")
simple.eda(CEWL_mod_dat_transf$mass_sqrt)
shapiro.test(CEWL_mod_dat_transf$mass_sqrt)

# log(mass)
CEWL_mod_dat_transf %>%
  ggplot(., aes(x = mass_log)) +
  geom_histogram(color = "black", fill="steelblue", bins=50) + 
  theme_classic() +
  xlab("LOG(mass)") + 
  ylab("Count")
simple.eda(CEWL_mod_dat_transf$mass_log)
shapiro.test(CEWL_mod_dat_transf$mass_log)

# sqrt(cloacal temp)
CEWL_mod_dat_transf %>%
  ggplot(., aes(x = cloacal_temp_sqrt)) +
  geom_histogram(color = "black", fill="steelblue", bins=50) + 
  theme_classic() +
  xlab("sqrt(cloacal temperature)") + 
  ylab("Count")
simple.eda(CEWL_mod_dat_transf$cloacal_temp_sqrt)
shapiro.test(CEWL_mod_dat_transf$cloacal_temp_sqrt)

# log(cloacal temp)
CEWL_mod_dat_transf %>%
  ggplot(., aes(x = cloacal_temp_log)) +
  geom_histogram(color = "black", fill="steelblue", bins=50) + 
  theme_classic() +
  xlab("LOG(cloacal temperature)") + 
  ylab("Count")
simple.eda(CEWL_mod_dat_transf$cloacal_temp_log)
shapiro.test(CEWL_mod_dat_transf$cloacal_temp_log)

# sqrt(wind)
CEWL_mod_dat_transf %>%
  ggplot(., aes(x = wind_sqrt)) +
  geom_histogram(color = "black", fill="steelblue", bins=50) + 
  theme_classic() +
  xlab("sqrt(wind)") + 
  ylab("Count")
simple.eda(CEWL_mod_dat_transf$wind_sqrt)
shapiro.test(CEWL_mod_dat_transf$wind_sqrt)

# log(wind)
CEWL_mod_dat_transf %>%
  ggplot(., aes(x = wind_log)) +
  geom_histogram(color = "black", fill="steelblue", bins=50) + 
  theme_classic() +
  xlab("LOG(wind)") + 
  ylab("Count")
simple.eda(CEWL_mod_dat_transf$wind_log)
shapiro.test(CEWL_mod_dat_transf$wind_log)

# sqrt(humidity)
CEWL_mod_dat_transf %>%
  ggplot(., aes(x = abhum_sqrt)) +
  geom_histogram(color = "black", fill="steelblue", bins=50) + 
  theme_classic() +
  xlab("sqrt(absolute humidity at capture)") + 
  ylab("Count")
simple.eda(CEWL_mod_dat_transf$abhum_sqrt)
shapiro.test(CEWL_mod_dat_transf$abhum_sqrt)

# log(humidity)
CEWL_mod_dat_transf %>%
  ggplot(., aes(x = abhum_log)) +
  geom_histogram(color = "black", fill="steelblue", bins=50) + 
  theme_classic() +
  xlab("LOG(absolute humidity at capture)") + 
  ylab("Count")
simple.eda(CEWL_mod_dat_transf$abhum_log)
shapiro.test(CEWL_mod_dat_transf$abhum_log)

# sqrt(temperature)
CEWL_mod_dat_transf %>%
  ggplot(., aes(x = temp_sqrt)) +
  geom_histogram(color = "black", fill="steelblue", bins=50) + 
  theme_classic() +
  xlab("sqrt(temperature at capture)") + 
  ylab("Count")
simple.eda(CEWL_mod_dat_transf$temp_sqrt)
shapiro.test(CEWL_mod_dat_transf$temp_sqrt)

# log(temperature)
CEWL_mod_dat_transf %>%
  ggplot(., aes(x = temp_log)) +
  geom_histogram(color = "black", fill="steelblue", bins=50) + 
  theme_classic() +
  xlab("LOG(temperature at capture)") + 
  ylab("Count")
simple.eda(CEWL_mod_dat_transf$temp_log)
shapiro.test(CEWL_mod_dat_transf$temp_log)
```

sqrt and log transformations did not improve any of them... 

Now check dependent variables:

```{r}
CEWL_transf <- all_data_long %>%
  mutate(TEWL_sqrt = sqrt(TEWL_g_m2h),
         TEWL_log = log(TEWL_g_m2h))

# sqrt(TEWL)
CEWL_transf %>%
  ggplot(., aes(x = TEWL_sqrt)) +
  geom_histogram(color = "black", fill="steelblue", bins=50) + 
  theme_classic() +
  xlab("sqrt(CEWL)") + 
  ylab("Count") + 
  facet_wrap(~region)

# log(temperature)
CEWL_transf %>%
  ggplot(., aes(x = TEWL_log)) +
  geom_histogram(color = "black", fill="steelblue", bins=50) + 
  theme_classic() +
  xlab("LOG(CEWL)") + 
  ylab("Count") + 
  facet_wrap(~region)

# stats for each region individually
# dewlap - log makes a better improvement, but still not normal
simple.eda(CEWL_mod_dat_transf$dewl_sqrt)
shapiro.test(CEWL_mod_dat_transf$dewl_sqrt)
simple.eda(CEWL_mod_dat_transf$dewl_log)
shapiro.test(CEWL_mod_dat_transf$dewl_log)
# dorsum - sqrt makes normal!, log still improves but not as much
simple.eda(CEWL_mod_dat_transf$dors_sqrt)
shapiro.test(CEWL_mod_dat_transf$dors_sqrt)
simple.eda(CEWL_mod_dat_transf$dors_log)
shapiro.test(CEWL_mod_dat_transf$dors_log)
# head - log transformation makes it normal!
simple.eda(CEWL_mod_dat_transf$head_sqrt)
shapiro.test(CEWL_mod_dat_transf$head_sqrt)
simple.eda(CEWL_mod_dat_transf$head_log)
shapiro.test(CEWL_mod_dat_transf$head_log)
# mitepatch - log transformation makes it *almost* normal!
simple.eda(CEWL_mod_dat_transf$mite_sqrt)
shapiro.test(CEWL_mod_dat_transf$mite_sqrt)
simple.eda(CEWL_mod_dat_transf$mite_log)
shapiro.test(CEWL_mod_dat_transf$mite_log)
# ventrum - sqrt transformation is slightly better, neither make it normal
simple.eda(CEWL_mod_dat_transf$vent_sqrt)
shapiro.test(CEWL_mod_dat_transf$vent_sqrt)
simple.eda(CEWL_mod_dat_transf$vent_log)
shapiro.test(CEWL_mod_dat_transf$vent_log)
```


### Transform & Model

I will log-transform CEWL and see whether it makes the models satisfy LMM assumptions better.

Run CEWL model 13 with log-transformed CEWL:

```{r}
CEWL_mod9_step13_transf <- nlme::lme(data = CEWL_mod_dat,
                         log(TEWL_g_m2h) ~ region*mass_g + 
                           cloacal_temp_C - mass_g, 
                          random = ~1|individual_ID) 
summary(CEWL_mod9_step13_transf)
```

The AIC is an order of magnitude smaller than the pre-transformed model, which is promising.

Run CEWL model 24 with log-transformed CEWL:

```{r}
CEWL_mod9_step24_transf <- nlme::lme(data = CEWL_mod_dat,
                         log(TEWL_g_m2h) ~ region*mass_g + 
                           cloacal_temp_C +
                           Wind_mph_interpol +
                           temp_C_interpol*abs_humidity_g_m3_interpol -
                           temp_C_interpol, 
                          random = ~1|individual_ID) 
summary(CEWL_mod9_step24_transf)
```

This model also dropped AIC by a magnitude.


### Re-Check Assumptions (13)

Linearity and Equal Variance:

```{r}
# calculate residuals
qqnorm((CEWL_mod9_step13_transf), ~resid(.))

res_CEWL_mod13_transf <- all_data_long %>%
  mutate(y_hat = case_when(region == "dewl" ~ (0.0863032*cloacal_temp_C + 0.0591557*mass_g + 0.2739968),
                           region == "dors" ~ (0.0863032*cloacal_temp_C + 0.0161704*mass_g + 0.2739968 + 0.5626286),
                           region == "head" ~ (0.0863032*cloacal_temp_C - 0.0070830*mass_g + 0.2739968 + 1.0298456),
                           region == "mite" ~ (0.0863032*cloacal_temp_C + 0.0684369	*mass_g + 0.2739968 + 0.1248128),
                           region == "vent" ~ (0.0863032*cloacal_temp_C + 0.0553029*mass_g + 0.2739968 + 0.4645734)),
         e = log(TEWL_g_m2h) - y_hat
         )

# plot
plot(CEWL_mod9_step13_transf)
ggplot(data = res_CEWL_mod13_transf, aes(x = y_hat, y = e)) +
  geom_point() + 
  theme_classic() + 
  xlab("predicted y (y-hat)") +
  ylab("residuals (e)") +
  ggtitle("CEWL Model 13 Residuals - log-transformed CEWL") +
  geom_hline(yintercept = 0)
```

This looks SO much better, no more fan shape, the linearity assumption should be satisfied.

Also plot the residuals ~ each predictor. In this case, region, cloacal temperature, and mass.

```{r}
# region
ggplot(data = res_CEWL_mod13_transf) + 
  geom_boxplot(aes(x = region, 
                   y = e, 
                   color = region
                   )) + 
  theme_classic() + 
  xlab("region") + 
  ylab("residuals (e)") + 
  theme(text = element_text(color = "black", family = "sans", size = 12),
        axis.text = element_text(color = "black", family = "sans", size = 10),
        legend.text.align = 0,
        legend.position = "none"
)

# cloacal temp
ggplot(data = res_CEWL_mod13_transf, aes(x = cloacal_temp_C, y = e)) +
  geom_point() + 
  theme_classic() + 
  xlab("cloacal temperature (x)") +
  ylab("residuals (e)") +
  ggtitle("CEWL Model 13 Residuals - log-transformed CEWL") +
  geom_hline(yintercept = 0)

# mass
ggplot(data = res_CEWL_mod13_transf, aes(x = mass_g, y = e)) +
  geom_point() + 
  theme_classic() + 
  xlab("mass (x)") +
  ylab("residuals (e)") +
  ggtitle("CEWL Model 13 Residuals - log-transformed CEWL") +
  geom_hline(yintercept = 0)
```

Residuals don't look too bad as far as patterning, but they are very unevenly distributed at the high cloacal temperatures, and irregularly distributed for mass generally.

Brown-Forsythe test to statistically check equal variance:

```{r}
# need to create the right data & format first
bf_data <- res_CEWL_mod13_transf %>%
  dplyr::filter(complete.cases(cloacal_temp_C, mass_g, TEWL_g_m2h)) %>%
  dplyr::mutate(middle_ct = median(cloacal_temp_C),
                side_ct = as.factor(cloacal_temp_C > middle_ct),
                middle_mass = median(mass_g),
                side_mass = as.factor(mass_g > middle_mass))

# now run test
bf.test(formula = e ~ side_ct, # y~x
        data = bf_data, # dataframe
        alpha = 0.05, # default 0.05
        na.rm = TRUE, # remove missing data before running?
        verbose = TRUE # print output to console?
        )
bf.test(formula = e ~ side_mass, # y~x
        data = bf_data, # dataframe
        alpha = 0.05, # default 0.05
        na.rm = TRUE, # remove missing data before running?
        verbose = TRUE # print output to console?
        )
```

Equal variance is still satisfied for both continuous predictor variables.


Now check normality:

```{r}
simple.eda(res_CEWL_mod13_transf$e)
shapiro.test(res_CEWL_mod13_transf$e)
```

Normality still not satisfied.


### Re-Check Assumptions (24)

Linearity and Equal Variance:

```{r}
# calculate residuals
qqnorm((CEWL_mod9_step24_transf), ~resid(.))

res_CEWL_mod24_transf <- all_data_long %>%
  mutate(y_hat = case_when(region == "dewl" ~ 
                              # cloacal temp effect
                             (0.0777459825*cloacal_temp_C +
                                # mass by region interaction
                                # baseline is dewlap
                                0.0563025949*mass_g -
                                # no individual mass effect
                                # wind
                                0.0350349879*Wind_mph_interpol +
                                # humidity
                                0.0890320865*abs_humidity_g_m3_interpol +
                                # humidity * temp interaction
                                0.0001017257*temp_C_interpol*abs_humidity_g_m3_interpol
                                # intercept, baseline is dewlap
                                -0.2749031883),
                           region == "dors" ~ 
                             # cloacal temp effect
                             (0.0777459825*cloacal_temp_C -
                                # mass by region interaction
                                0.0430395327*mass_g + 
                                # individual mass effect
                                0.0563025949*mass_g -
                                # wind
                                0.0350349879*Wind_mph_interpol +
                                # humidity
                                0.0890320865*abs_humidity_g_m3_interpol +
                                # humidity * temp interaction
                                0.0001017257*temp_C_interpol*abs_humidity_g_m3_interpol
                                # intercept
                                -0.2749031883
                                # intercept by region
                                + 0.5631512148
                                ),
                           region == "head" ~ 
                             # cloacal temp effect
                             (0.0777459825*cloacal_temp_C -
                                # mass by region interaction
                                0.0663447385*mass_g + 
                                # individual mass effect
                                0.0563025949*mass_g -
                                # wind
                                0.0350349879*Wind_mph_interpol +
                                # humidity
                                0.0890320865*abs_humidity_g_m3_interpol +
                                # humidity * temp interaction
                                0.0001017257*temp_C_interpol*abs_humidity_g_m3_interpol
                                # intercept
                                -0.2749031883
                                # intercept by region
                                + 1.0311487525
                                ),
                           region == "mite" ~ 
                             # cloacal temp effect
                             (0.0777459825*cloacal_temp_C +
                                # mass by region interaction
                                0.0097068090*mass_g + 
                                # individual mass effect
                                0.0563025949*mass_g -
                                # wind
                                0.0350349879*Wind_mph_interpol +
                                # humidity
                                0.0890320865*abs_humidity_g_m3_interpol +
                                # humidity * temp interaction
                                0.0001017257*temp_C_interpol*abs_humidity_g_m3_interpol
                                # intercept
                                -0.2749031883
                                # intercept by region
                                + 0.1195215574
                                ),
                           region == "vent" ~ 
                             # cloacal temp effect
                             (0.0777459825*cloacal_temp_C -
                                # mass by region interaction
                                0.0041379689*mass_g + 
                                # individual mass effect
                                0.0563025949*mass_g -
                                # wind
                                0.0350349879*Wind_mph_interpol +
                                # humidity
                                0.0890320865*abs_humidity_g_m3_interpol +
                                # humidity * temp interaction
                                0.0001017257*temp_C_interpol*abs_humidity_g_m3_interpol
                                # intercept
                                -0.2749031883
                                # intercept by region
                                + 0.4678755668
                                )),
         e = log(TEWL_g_m2h) - y_hat
         )

# plot
plot(CEWL_mod9_step24_transf)
ggplot(data = res_CEWL_mod24_transf, aes(x = y_hat, y = e)) +
  geom_point() + 
  theme_classic() + 
  xlab("predicted y (y-hat)") +
  ylab("residuals (e)") +
  ggtitle("CEWL Model 24 Residuals - log-transformed CEWL") +
  geom_hline(yintercept = 0)
```

This looks SO much better, no more fan shape, the linearity assumption should be satisfied.

Also plot the residuals ~ each predictor. In this case, region, cloacal temperature, mass, wind speed, absolute humidity, and temperature.

```{r}
# region
ggplot(data = res_CEWL_mod24_transf) + 
  geom_boxplot(aes(x = region, 
                   y = e, 
                   color = region
                   )) + 
  theme_classic() + 
  xlab("region") + 
  ylab("residuals (e)") + 
  theme(text = element_text(color = "black", family = "sans", size = 12),
        axis.text = element_text(color = "black", family = "sans", size = 10),
        legend.text.align = 0,
        legend.position = "none"
)

# cloacal temp
ggplot(data = res_CEWL_mod24_transf, aes(x = cloacal_temp_C, y = e)) +
  geom_point() + 
  theme_classic() + 
  xlab("cloacal temperature (x)") +
  ylab("residuals (e)") +
  ggtitle("CEWL Model 13 Residuals - log-transformed CEWL") +
  geom_hline(yintercept = 0)

# mass
ggplot(data = res_CEWL_mod24_transf, aes(x = mass_g, y = e)) +
  geom_point() + 
  theme_classic() + 
  xlab("mass (x)") +
  ylab("residuals (e)") +
  ggtitle("CEWL Model 13 Residuals - log-transformed CEWL") +
  geom_hline(yintercept = 0)

# wind speed
ggplot(data = res_CEWL_mod24_transf, aes(x = Wind_mph_interpol, y = e)) +
  geom_point() + 
  theme_classic() + 
  xlab("wind speed (x)") +
  ylab("residuals (e)") +
  ggtitle("CEWL Model 13 Residuals - log-transformed CEWL") +
  geom_hline(yintercept = 0)

# abs humidity
ggplot(data = res_CEWL_mod24_transf, 
       aes(x = abs_humidity_g_m3_interpol, y = e)) +
  geom_point() + 
  theme_classic() + 
  xlab("absolute humidity (x)") +
  ylab("residuals (e)") +
  ggtitle("CEWL Model 13 Residuals - log-transformed CEWL") +
  geom_hline(yintercept = 0)

# temperature
ggplot(data = res_CEWL_mod24_transf, aes(x = temp_C_interpol, y = e)) +
  geom_point() + 
  theme_classic() + 
  xlab("temperature (x)") +
  ylab("residuals (e)") +
  ggtitle("CEWL Model 13 Residuals - log-transformed CEWL") +
  geom_hline(yintercept = 0)
```

Same issue with cloacal temperature as the other model's assumptions, but otherwise the residuals look reasonable. 


Brown-Forsythe test to statistically check equal variance:

```{r}
# need to create the right data & format first
bf_data <- res_CEWL_mod24_transf %>%
  dplyr::filter(complete.cases(cloacal_temp_C, 
                               mass_g, 
                               Wind_mph_interpol,
                               abs_humidity_g_m3_interpol,
                               temp_C_interpol,
                               TEWL_g_m2h)) %>%
  dplyr::mutate(middle_ct = median(cloacal_temp_C),
                side_ct = as.factor(cloacal_temp_C > middle_ct),
                
                middle_mass = median(mass_g),
                side_mass = as.factor(mass_g > middle_mass),
                
                middle_wind = median(Wind_mph_interpol),
                side_wind = as.factor(Wind_mph_interpol > middle_wind),
                
                middle_hum = median(abs_humidity_g_m3_interpol),
                side_hum = as.factor(abs_humidity_g_m3_interpol > middle_hum),
                
                middle_temp = median(temp_C_interpol),
                side_temp = as.factor(temp_C_interpol > middle_temp))

# now run test
bf.test(formula = e ~ side_ct, # y~x
        data = bf_data, # dataframe
        alpha = 0.05, # default 0.05
        na.rm = TRUE, # remove missing data before running?
        verbose = TRUE # print output to console?
        )
bf.test(formula = e ~ side_mass, # y~x
        data = bf_data, # dataframe
        alpha = 0.05, # default 0.05
        na.rm = TRUE, # remove missing data before running?
        verbose = TRUE # print output to console?
        )
bf.test(formula = e ~ side_wind, # y~x
        data = bf_data, # dataframe
        alpha = 0.05, # default 0.05
        na.rm = TRUE, # remove missing data before running?
        verbose = TRUE # print output to console?
        )
bf.test(formula = e ~ side_hum, # y~x
        data = bf_data, # dataframe
        alpha = 0.05, # default 0.05
        na.rm = TRUE, # remove missing data before running?
        verbose = TRUE # print output to console?
        )
bf.test(formula = e ~ side_temp, # y~x
        data = bf_data, # dataframe
        alpha = 0.05, # default 0.05
        na.rm = TRUE, # remove missing data before running?
        verbose = TRUE # print output to console?
        )
```

Equal variance is still satisfied for all continuous predictor variables.


Now check normality:

```{r}
simple.eda(res_CEWL_mod24_transf$e)
shapiro.test(res_CEWL_mod24_transf$e)
```

Residuals normality still not satisfied. 


### Conclusion

Both CEWL models should use log-transformed CEWL because this greatly improves the models based on AIC and it allows the model to satisfy the linearity assumption of LMM. 

```{r}
# save transformed model 24 summary object
CEWL_log_best_mod1 <- summary(CEWL_mod9_step24_transf)
# extract stats table from summary object
CEWL_log_best_mod1_vals <- data.frame(CEWL_log_best_mod1$tTable)
# export 
write.csv(CEWL_log_best_mod1_vals, "CEWL_log_mod1_vals.csv")

# save transformed model 13 summary object
CEWL_log_best_mod2 <- summary(CEWL_mod9_step13_transf)
# extract stats table from summary object
CEWL_log_best_mod2_vals <- data.frame(CEWL_log_best_mod2$tTable)
# export 
write.csv(CEWL_log_best_mod2_vals, "CEWL_log_mod2_vals.csv")
```


# to-do:

- ask whether cloacal temperature should be a random effect =- 
Cloacal temperature is better as a fixed effect in both cases. It's better to omit cloacal temperature than it is to change it to a random effect. 
- *Unsure whether or not to add it...* The region*humidity interaction is significant, and with it, the model has a lower AIC, but it also makes the model much more complicated...

look at how model stats are presented in tables and model it after that

maybe: Calculate estimates of TEWL based on equations presented in (6).  How much do the estimates vary depending on which CEWL we use? Can we figure out how to use all of our different CEWL measurements to calculate what we think would be an accurate TEWL?


# What to Present in the Paper

- SLR for hct
- top 2 GLMM for osmolality (including random effects)
- top 2 GLMM for CEWL (including random effects)

---
title: "Power Analysis for Future Hydration Studies"
author: "Savannah Weaver"
date: "August 2021"
output: pdf_document
---

# Packages

```{r setup, include=FALSE}
if (!require("tidyverse")) install.packages("tidyverse")
library("tidyverse")
if (!require("UsingR")) install.packages("UsingR")
library("UsingR")
if (!require("simr")) install.packages("simr")
library("simr") # more complex power analysis
if (!require("lme4")) install.packages("lme4")
library("lme4") # for LMMs
if (!require("ggpubr")) install.packages("ggpubr")
library("ggpubr") # for ggplot multi-figures
```


# Goals

Perform a power analysis on preliminary data to figure out how many lizards I would need to have in my study to find significant differences in hematocrit, osmolality, and evaporative water loss based on climate treatment, if those differences are there. 

Factors to remember/include:
- 2x2 factorial treatment groups
- measurements over time (start, middle, end)
- trial number and individual as random factors



# Load & Augment Data

Since my first try of doing this experiment only had temperature 25C, I'm going to duplicate the data and remake it as 35C so I can build a model off of that.


## CEWL 

```{r load CEWL data}
# real CEWL data
CEWL <- read.csv("./exported_data/exp_effects_CEWL.csv",
                             na.strings=c("","NA")
                             ) %>%
  dplyr::mutate(date = as.Date(date, format = "%Y-%m-%d"),
                region = as.factor(region),
                humidity_tmt_percent = as.factor(humidity_tmt_percent),
                individual_ID = as.factor(individual_ID),
                trial_number = as.factor(trial_number),
                day = as.factor(day)
                ) %>%
  dplyr::select(-X) %>%
  dplyr::filter(complete.cases(TEWL_g_m2h))
summary(CEWL)

# make fake
fake_35C_CEWL <- CEWL %>%
  mutate(temp_tmt_C = 35)

# join & format
fake_CEWL_dat <- fake_35C_CEWL %>%
  rbind(CEWL) %>%
  # make indiv ID and trial num factors
  mutate(individual_ID = as.factor(individual_ID),
         trial_number = as.factor(trial_number),
         #temp_tmt_C = as.factor(temp_tmt_C) # CANNOT BE A FACTOR ?!
         )

# check
summary(fake_CEWL_dat)
```


## Hydration

```{r}
# real hydration data
hydration <- read.csv("./exported_data/exp_effects_hydration.csv",
                             na.strings=c("","NA")
                             ) %>%
  dplyr::filter(type %in% c("exp", "capture")) %>% # don't include rehab
  dplyr::mutate(date = as.Date(date, format = "%Y-%m-%d"),
                type = as.factor(type),
                humidity_tmt_percent = as.factor(humidity_tmt_percent),
                individual_ID = as.factor(individual_ID),
                trial_number = as.factor(trial_number)
                ) %>%
  dplyr::select(-X) 
summary(hydration)

# make fake
fake_35C_hyd <- hydration %>%
  mutate(temp_tmt_C = 35)

# join & format
fake_hydration_dat <- fake_35C_hyd %>%
  rbind(hydration) %>%
  # make indiv ID and trial num factors
  mutate(individual_ID = as.factor(individual_ID),
         trial_number = as.factor(trial_number),
         temp_tmt_C = as.factor(temp_tmt_C))

# check
summary(fake_hydration_dat)
```




# CEWL 

## Model

```{r}
CEWL_mod_fake <- lme4::lmer(data = fake_CEWL_dat,
                         TEWL_g_m2h ~ 
                         temp_tmt_C*humidity_tmt_percent*day + region +
                         (1|trial_number/individual_ID))
                    # random effect of individual nested within trial number
```

region, humidity treatment, before/after, and the before/after interaction with treatment are all significant and important


## Power Analysis Calculations

```{r}
num_liz <- (4:12)*10 # TOTAL number of lizards 40-120

CEWL_extensions <- purrr::map(num_liz,
                  function(x)
                    extend(CEWL_mod_fake, along = "individual_ID", n = x))

# temp:humidity INTERACTION effect over course of experiment
CEWL_powersimsboth <- map_dfr(CEWL_extensions,
                 ~powerSim(.x,
                           fixed("temp_tmt_C:humidity_tmt_percent:day", "lr"),
                           nsim = 100) %>%
                   summary()
)

CEWL_powersimsboth$sample_size = num_liz

# humidity only
CEWL_powersimshum <- map_dfr(CEWL_extensions,
                 ~powerSim(.x,
                           fixed("humidity_tmt_percent:day", "lr"),
                           nsim = 100) %>%
                   summary()
)

CEWL_powersimshum$sample_size = num_liz

# temp only
CEWL_powersimstemp <- map_dfr(CEWL_extensions,
                 ~powerSim(.x,
                           fixed("temp_tmt_C:day", "lr"),
                           nsim = 100) %>%
                   summary()
)

CEWL_powersimstemp$sample_size = num_liz
```


## Figures

```{r}
CEWL_sim_fig_both <- CEWL_powersimsboth %>%
  ggplot(aes(x = sample_size, y = mean)) +
  geom_point() +
  geom_line() +
  theme_classic() +
  scale_x_continuous(breaks = c((4:12)*10)) +
  geom_hline(yintercept = .8, color = "darkorchid4") +
  geom_hline(yintercept = 1, color = "chartreuse4") +
  geom_hline(yintercept = .9, color = "darkblue") +
  geom_errorbar(aes(ymin = lower, ymax = upper)) +
  ggtitle("CEWL ~ Temp*Humidity*Day Power Analysis") +
  ylab("Mean Power to Detect Differences") + 
  xlab("Total Sample Size Across Tmts & Trials")

CEWL_sim_fig_hum <- CEWL_powersimshum %>%
  ggplot(aes(x = sample_size, y = mean)) +
  geom_point() +
  geom_line() +
  theme_classic() +
  scale_x_continuous(breaks = c((4:12)*10)) +
  geom_hline(yintercept = .8, color = "darkorchid4") +
  geom_hline(yintercept = 1, color = "chartreuse4") +
  geom_hline(yintercept = .9, color = "darkblue") +
  geom_errorbar(aes(ymin = lower, ymax = upper)) +
  ggtitle("CEWL ~ Humidity*Day Power Analysis") +
  ylab("Mean Power to Detect Differences") + 
  xlab("Total Sample Size Across Tmts & Trials")

CEWL_sim_fig_temp <- CEWL_powersimstemp %>%
  ggplot(aes(x = sample_size, y = mean)) +
  geom_point() +
  geom_line() +
  theme_classic() +
  scale_x_continuous(breaks = c((4:12)*10)) +
  geom_hline(yintercept = .8, color = "darkorchid4") +
  geom_hline(yintercept = 1, color = "chartreuse4") +
  geom_hline(yintercept = .9, color = "darkblue") +
  geom_errorbar(aes(ymin = lower, ymax = upper)) +
  ggtitle("CEWL ~ Temp*Day Power Analysis") +
  ylab("Mean Power to Detect Differences") + 
  xlab("Total Sample Size Across Tmts & Trials")

CEWL_multi_power_fig <- ggarrange(CEWL_sim_fig_both, 
                                  CEWL_sim_fig_hum, 
                                  CEWL_sim_fig_temp, 
                                  ncol = 1, nrow = 3)

ggsave(filename = "power_sim_fig_CEWL.jpeg",
       plot = CEWL_multi_power_fig,
       path = "./power_analysis",
       device = "jpeg",
       dpi = 1200,
       width = 6, height = 12)
```



# Hydration

## Model

```{r}
osml_mod_fake <- lme4::lmer(data = fake_hydration_dat,
                         osmolality_mmol_kg ~ 
                         temp_tmt_C*humidity_tmt_percent*day + 
                          (1|trial_number))
summary(osml_mod_fake)
```
humidity treatment, day, and their interaction are all already important for osmolality

## Power Analysis Calculations

```{r}
osml_extensions <- purrr::map(num_liz,
                  function(x)
                    extend(osml_mod_fake, along = "individual_ID", n = x))

# temp:humidity INTERACTION effect over course of experiment
osml_powersimsboth <- map_dfr(osml_extensions,
                 ~powerSim(.x,
                           fixed("temp_tmt_C:humidity_tmt_percent:day", "lr"),
                           nsim = 100) %>%
                   summary()
)

osml_powersimsboth$sample_size = num_liz

# humidity only
osml_powersimshum <- map_dfr(osml_extensions,
                 ~powerSim(.x,
                           fixed("humidity_tmt_percent:day", "lr"),
                           nsim = 100) %>%
                   summary()
)

osml_powersimshum$sample_size = num_liz

# temp only
osml_powersimstemp <- map_dfr(osml_extensions,
                 ~powerSim(.x,
                           fixed("temp_tmt_C:day", "lr"),
                           nsim = 100) %>%
                   summary()
)

osml_powersimstemp$sample_size = num_liz
```


## Figures

```{r}
osml_sim_fig_both <- osml_powersimsboth %>%
  ggplot(aes(x = sample_size, y = mean)) +
  geom_point() +
  geom_line() +
  theme_classic() +
  scale_x_continuous(breaks = c((4:12)*10)) +
  geom_hline(yintercept = .8, color = "darkorchid4") +
  geom_hline(yintercept = 1, color = "chartreuse4") +
  geom_hline(yintercept = .9, color = "darkblue") +
  geom_errorbar(aes(ymin = lower, ymax = upper)) +
  ggtitle("Osmolality ~ Temp*Humidity*Day Power Analysis") +
  ylab("Mean Power to Detect Differences") + 
  xlab("Total Sample Size Across Tmts & Trials")

osml_sim_fig_hum <- osml_powersimshum %>%
  ggplot(aes(x = sample_size, y = mean)) +
  geom_point() +
  geom_line() +
  theme_classic() +
  scale_x_continuous(breaks = c((4:12)*10)) +
  geom_hline(yintercept = .8, color = "darkorchid4") +
  geom_hline(yintercept = 1, color = "chartreuse4") +
  geom_hline(yintercept = .9, color = "darkblue") +
  geom_errorbar(aes(ymin = lower, ymax = upper)) +
  ggtitle("Osmolality ~ Humidity*Day Power Analysis") +
  ylab("Mean Power to Detect Differences") + 
  xlab("Total Sample Size Across Tmts & Trials")

osml_sim_fig_temp <- osml_powersimstemp %>%
  ggplot(aes(x = sample_size, y = mean)) +
  geom_point() +
  geom_line() +
  theme_classic() +
  scale_x_continuous(breaks = c((4:12)*10)) +
  geom_hline(yintercept = .8, color = "darkorchid4") +
  geom_hline(yintercept = 1, color = "chartreuse4") +
  geom_hline(yintercept = .9, color = "darkblue") +
  geom_errorbar(aes(ymin = lower, ymax = upper)) +
  ggtitle("Osmolality ~ Temp*Day Power Analysis") +
  ylab("Mean Power to Detect Differences") + 
  xlab("Total Sample Size Across Tmts & Trials")

osml_multi_power_fig <- ggarrange(osml_sim_fig_both, 
                                  osml_sim_fig_hum, 
                                  osml_sim_fig_temp, 
                                  ncol = 1, nrow = 3)

ggsave(filename = "power_sim_fig_osml.jpeg",
       plot = osml_multi_power_fig,
       path = "./power_analysis",
       device = "jpeg",
       dpi = 1200,
       width = 6, height = 12)
```





# Hematocrit

## Model

```{r}
hct_mod_fake <- lme4::lmer(data = fake_hydration_dat,
                         hematocrit_percent ~ 
                         temp_tmt_C * humidity_tmt_percent * day + 
                         (1|trial_number))
summary(hct_mod_fake)
```

only day is important for hematocrit


## Power Analysis Calculations

```{r}
hct_extensions <- purrr::map(num_liz,
                  function(x)
                    extend(hct_mod_fake, along = "individual_ID", n = x))

# temp:humidity INTERACTION effect over course of experiment
hct_powersimsboth <- map_dfr(hct_extensions,
                 ~powerSim(.x,
                           fixed("temp_tmt_C:humidity_tmt_percent:day", "lr"),
                           nsim = 100) %>%
                   summary()
)

hct_powersimsboth$sample_size = num_liz

# humidity only
hct_powersimshum <- map_dfr(hct_extensions,
                 ~powerSim(.x,
                           fixed("humidity_tmt_percent:day", "lr"),
                           nsim = 100) %>%
                   summary()
)

hct_powersimshum$sample_size = num_liz

# temp only
hct_powersimstemp <- map_dfr(hct_extensions,
                 ~powerSim(.x,
                           fixed("temp_tmt_C:day", "lr"),
                           nsim = 100) %>%
                   summary()
)

hct_powersimstemp$sample_size = num_liz
```


## Figures

```{r}
hct_sim_fig_both <- hct_powersimsboth %>%
  ggplot(aes(x = sample_size, y = mean)) +
  geom_point() +
  geom_line() +
  theme_classic() +
  scale_x_continuous(breaks = c((4:12)*10)) +
  geom_hline(yintercept = .8, color = "darkorchid4") +
  geom_hline(yintercept = 1, color = "chartreuse4") +
  geom_hline(yintercept = .9, color = "darkblue") +
  geom_errorbar(aes(ymin = lower, ymax = upper)) +
  ggtitle("Hematocrit ~ Temp*Humidity*Day Power Analysis") +
  ylab("Mean Power to Detect Differences") + 
  xlab("Total Sample Size Across Tmts & Trials")

hct_sim_fig_hum <- hct_powersimshum %>%
  ggplot(aes(x = sample_size, y = mean)) +
  geom_point() +
  geom_line() +
  theme_classic() +
  scale_x_continuous(breaks = c((4:12)*10)) +
  geom_hline(yintercept = .8, color = "darkorchid4") +
  geom_hline(yintercept = 1, color = "chartreuse4") +
  geom_hline(yintercept = .9, color = "darkblue") +
  geom_errorbar(aes(ymin = lower, ymax = upper)) +
  ggtitle("Hematocrit ~ Humidity*Day Power Analysis") +
  ylab("Mean Power to Detect Differences") + 
  xlab("Total Sample Size Across Tmts & Trials")

hct_sim_fig_temp <- hct_powersimstemp %>%
  ggplot(aes(x = sample_size, y = mean)) +
  geom_point() +
  geom_line() +
  theme_classic() +
  scale_x_continuous(breaks = c((4:12)*10)) +
  geom_hline(yintercept = .8, color = "darkorchid4") +
  geom_hline(yintercept = 1, color = "chartreuse4") +
  geom_hline(yintercept = .9, color = "darkblue") +
  geom_errorbar(aes(ymin = lower, ymax = upper)) +
  ggtitle("Hematocrit ~ Temp*Day Power Analysis") +
  ylab("Mean Power to Detect Differences") + 
  xlab("Total Sample Size Across Tmts & Trials")

hct_multi_power_fig <- ggarrange(hct_sim_fig_both, 
                                  hct_sim_fig_hum, 
                                  hct_sim_fig_temp, 
                                  ncol = 1, nrow = 3)

ggsave(filename = "power_sim_fig_hct.jpeg",
       plot = hct_multi_power_fig,
       path = "./power_analysis",
       device = "jpeg",
       dpi = 1200,
       width = 6, height = 12)
```




# SMI (Mass)

## Model

```{r}
SMI_mod_fake <- lme4::lmer(data = fake_hydration_dat,
                         mass_g ~ 
                           temp_tmt_C * humidity_tmt_percent * day + 
                         (1|trial_number))
summary(SMI_mod_fake)
```

only day is really important for scaled mass index, so this is definitely an important variable for doing power analysis



## Power Analysis Calculations

```{r}
SMI_extensions <- purrr::map(num_liz,
                  function(x)
                    extend(SMI_mod_fake, along = "individual_ID", n = x))

# temp:humidity INTERACTION effect over course of experiment
SMI_powersimsboth <- map_dfr(SMI_extensions,
                 ~powerSim(.x,
                           fixed("temp_tmt_C:humidity_tmt_percent:day", "lr"),
                           nsim = 100) %>%
                   summary()
)

SMI_powersimsboth$sample_size = num_liz

# humidity only
SMI_powersimshum <- map_dfr(SMI_extensions,
                 ~powerSim(.x,
                           fixed("humidity_tmt_percent:day", "lr"),
                           nsim = 100) %>%
                   summary()
)

SMI_powersimshum$sample_size = num_liz

# temp only
SMI_powersimstemp <- map_dfr(SMI_extensions,
                 ~powerSim(.x,
                           fixed("temp_tmt_C:day", "lr"),
                           nsim = 100) %>%
                   summary()
)

SMI_powersimstemp$sample_size = num_liz
```


## Figures

```{r}
SMI_sim_fig_both <- SMI_powersimsboth %>%
  ggplot(aes(x = sample_size, y = mean)) +
  geom_point() +
  geom_line() +
  theme_classic() +
  scale_x_continuous(breaks = c((4:12)*10)) +
  geom_hline(yintercept = .8, color = "darkorchid4") +
  geom_hline(yintercept = 1, color = "chartreuse4") +
  geom_hline(yintercept = .9, color = "darkblue") +
  geom_errorbar(aes(ymin = lower, ymax = upper)) +
  ggtitle("SMI ~ Temp*Humidity*Day Power Analysis") +
  ylab("Mean Power to Detect Differences") + 
  xlab("Total Sample Size Across Tmts & Trials")

SMI_sim_fig_hum <- SMI_powersimshum %>%
  ggplot(aes(x = sample_size, y = mean)) +
  geom_point() +
  geom_line() +
  theme_classic() +
  scale_x_continuous(breaks = c((4:12)*10)) +
  geom_hline(yintercept = .8, color = "darkorchid4") +
  geom_hline(yintercept = 1, color = "chartreuse4") +
  geom_hline(yintercept = .9, color = "darkblue") +
  geom_errorbar(aes(ymin = lower, ymax = upper)) +
  ggtitle("SMI ~ Humidity*Day Power Analysis") +
  ylab("Mean Power to Detect Differences") + 
  xlab("Total Sample Size Across Tmts & Trials")

SMI_sim_fig_temp <- SMI_powersimstemp %>%
  ggplot(aes(x = sample_size, y = mean)) +
  geom_point() +
  geom_line() +
  theme_classic() +
  scale_x_continuous(breaks = c((4:12)*10)) +
  geom_hline(yintercept = .8, color = "darkorchid4") +
  geom_hline(yintercept = 1, color = "chartreuse4") +
  geom_hline(yintercept = .9, color = "darkblue") +
  geom_errorbar(aes(ymin = lower, ymax = upper)) +
  ggtitle("SMI ~ Temp*Day Power Analysis") +
  ylab("Mean Power to Detect Differences") + 
  xlab("Total Sample Size Across Tmts & Trials")

SMI_multi_power_fig <- ggarrange(SMI_sim_fig_both, 
                                  SMI_sim_fig_hum, 
                                  SMI_sim_fig_temp, 
                                  ncol = 1, nrow = 3)

ggsave(filename = "power_sim_fig_SMI.jpeg",
       plot = SMI_multi_power_fig,
       path = "./power_analysis",
       device = "jpeg",
       dpi = 1200,
       width = 6, height = 12)
```






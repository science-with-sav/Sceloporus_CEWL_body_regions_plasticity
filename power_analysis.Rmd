---
title: "Power Analysis for Future Hydration Studies"
author: "Savannah Weaver"
date: "June 2021"
output: pdf_document
---

# Packages

```{r setup, include=FALSE}
if (!require("tidyverse")) install.packages("tidyverse")
library("tidyverse")
if (!require("UsingR")) install.packages("UsingR")
library("UsingR")
if (!require("pwr")) install.packages("pwr")
library("pwr") # basic power analysis
if (!require("simr")) install.packages("simr")
library("simr") # more complex power analysis
if (!require("nlme")) install.packages("nlme")
library("nlme") # for LMMs
if (!require("purrr")) install.packages("purrr")
library("purrr")
```


# Goals

Perform a power analysis on preliminary data to figure out how many lizards I would need to have in my study to find significant differences in hematocrit, osmolality, and evaporative water loss based on climate treatment, if those differences are there. 

Factors to remember/include:
- 2x2 factorial treatment groups
- measurements over time (start, middle, end)
- trial number and individual as random factors



# Load Data

```{r load data}
# CEWL data
CEWL <- read.csv("./exported_data/exp_effects_CEWL.csv",
                             na.strings=c("","NA")
                             ) %>%
  dplyr::mutate(date = as.Date(date, format = "%Y-%m-%d"),
                region = as.factor(region),
                humidity_tmt_percent = as.factor(humidity_tmt_percent),
                individual_ID = as.factor(individual_ID),
                trial_number = as.factor(trial_number),
                day = as.factor(day)
                ) %>%
  dplyr::select(-X) %>%
  dplyr::filter(complete.cases(TEWL_g_m2h))
summary(CEWL)

# hydration data
hydration <- read.csv("./exported_data/exp_effects_hydration.csv",
                             na.strings=c("","NA")
                             ) %>%
  dplyr::filter(type %in% c("exp", "capture")) %>%
  dplyr::mutate(date = as.Date(date, format = "%Y-%m-%d"),
                type = as.factor(type),
                humidity_tmt_percent = as.factor(humidity_tmt_percent),
                individual_ID = as.factor(individual_ID),
                trial_number = as.factor(trial_number)
                ) %>%
  dplyr::select(-X) 
summary(hydration)
```





# Data Prep

Since my first try of doing this experiment only had temperature 25C, I'm going to duplicate the data and remake it as 35C so I can build a model off of that.

*Does this even make sense?*

## Hydration

```{r}
# make fake
fake_35C_hyd <- hydration %>%
  mutate(temp_tmt_C = 35)

# join & format
fake_hydration_dat <- fake_35C_hyd %>%
  rbind(hydration) %>%
  # make indiv ID and trial num factors
  mutate(individual_ID = as.factor(individual_ID),
         trial_number = as.factor(trial_number),
         temp_tmt_C = as.factor(temp_tmt_C))

# check
summary(fake_hydration_dat)
```

## CEWL

```{r}
# make fake
fake_35C_CEWL <- CEWL %>%
  mutate(temp_tmt_C = 35)

# join & format
fake_CEWL_dat <- fake_35C_CEWL %>%
  rbind(CEWL) %>%
  # make indiv ID and trial num factors
  mutate(individual_ID = as.factor(individual_ID),
         trial_number = as.factor(trial_number),
         temp_tmt_C = as.factor(temp_tmt_C))

# check
summary(fake_CEWL_dat)
```


## Effect Sizes

Calculate the desired effect sizes for each variable as (mean treatment (humid) - mean control (dry)) / sd control. 

```{r}
effects <- hydration %>%
  group_by(humidity_tmt_percent) %>%
  summarise(mean_osml = mean(osmolality_mmol_kg, na.rm = TRUE),
            sd_osml = sd(osmolality_mmol_kg, na.rm = TRUE),
            mean_hct = mean(hematocrit_percent, na.rm = TRUE),
            sd_hct = sd(hematocrit_percent, na.rm = TRUE),
            mean_mass = mean(mass_g),
            sd_mass = sd(mass_g)
            )
effects
```


# Create Models

## Osmolality

```{r}
# compute with fake temperature effects
osmol_mod <- lme4::lmer(data = fake_hydration_dat,
                         osmolality_mmol_kg ~ 
                         temp_tmt_C*humidity_tmt_percent*day + 
                          (1|trial_number))
summary(osmol_mod)

# compute without fake temperature effects
osmol_mod_real <- lme4::lmer(data = hydration,
                         osmolality_mmol_kg ~ 
                         humidity_tmt_percent*day + 
                          (1|trial_number))

summary(osmol_mod_real)
```
humidity treatment, day, and their interaction are all important for osmolality


## Hematocrit

```{r}
hct_mod_real <- lme4::lmer(data = hydration,
                         hematocrit_percent ~ 
                         #temp_tmt_C * 
                           humidity_tmt_percent * day + 
                         (1|trial_number))
summary(hct_mod_real)
```

only day is important for hematocrit



## SMI (Mass)

```{r}
SMI_mod_real <- lme4::lmer(data = hydration,
                         mass_g ~ humidity_tmt_percent * day + 
                         (1|trial_number))
summary(SMI_mod_real)
```

only day is really important for scaled mass index, so this is definitely an important variable for doing power analysis


## CEWL

```{r}
# compute with fake data
CEWL_mod <- lme4::lmer(data = fake_CEWL_dat,
                         TEWL_g_m2h ~ 
                         temp_tmt_C*humidity_tmt_percent*day + region +
                         (1|trial_number/individual_ID))
                    # random effect of individual nested within trial number
summary(CEWL_mod)

# compute without fake data
CEWL_mod_real <- lme4::lmer(data = CEWL,
                         TEWL_g_m2h ~ 
                         humidity_tmt_percent*day + region +
                         (1|trial_number/individual_ID))
                    # random effect of individual nested within trial number
summary(CEWL_mod_real)
```

region, humidity treatment, before/after, and the before/after interaction with treatment are all significant and important


# Power Analyses

Now that I have models for everything, I'll go through and test the power of each predictor variable (including interactions) to guess-timate whether my current sample size could be effective in distinguishing the same differences in future, slightly different studies. 

```{r}
CEWL_mod_ext <- extend(CEWL_mod_real,
                       along = "individual_ID",
                       n = 40)

powerSim(CEWL_mod_ext, 
         fixed("humidity_tmt_percent:day", "lr"), 
         nsim = 20) 
```

```{r}
num_liz <- (4:10)*10

#CEWL_mod <- lme4::lmer(data = fake_CEWL_dat,
 #                        TEWL_g_m2h ~
  #                       temp_tmt_C*humidity_tmt_percent*day + region +
   #                      (1|trial_number/individual_ID))

extensions <- purrr::map(num_liz,
                  function(x)
                    extend(CEWL_mod_real, along = "individual_ID", n = x))

powersims <- map_dfr(extensions,
                 ~powerSim(.x,
                           fixed("humidity_tmt_percent:day", "lr"),
                           nsim = 20) %>%
                   summary()
)

powersims$sample_size = num_liz

powersims %>%
  ggplot(aes(x = sample_size, y = mean)) +
  geom_point() +
  geom_line() +
  theme_classic() +
  geom_hline(yintercept = .8) +
  geom_errorbar(aes(ymin = lower, ymax = upper))

```



## Osmolality

First, see what the power was for the preliminary trials we did.

```{r}
powerSim(osmol_mod2, fixed("humidity_tmt_percent","lr"), nsim = 50) # 8-31
powerSim(osmol_mod2, fixed("day","lr"), nsim = 50) # 0-7
powerSim(osmol_mod2, fixed("humidity_tmt_percent:day","lr"), nsim = 50) # 21-49
```


Now, compute the effect of increased sample sizes within treatment groups for each trial. This addresses how much power we can get if we increase the sample size within trials and treatment groups, and do the same number of treatment groups and trials as the data used to compute the power.

```{r}
osml_mod_ext <- extend(osmol_mod2,
                       within = "humidity_tmt_percent +
                       trial_number", 
                       n = 10)
```

Next, run powerSim to determine the power for the various sample sizes.

```{r}
# designate effect size desired to detect
fixef(osml_mod_ext) <- 1/26 # just estimating rn.... so small... 
# run simulation
osml_sim <- powerCurve(osml_mod_ext, 
                     test = fixed('humidity_tmt_percent', 'lr'),
                     within = "humidity_tmt_percent"
                     )
```

Finally, plot to see how sample size affects power:

```{r}
plot(osml_sim)
```





## Hematocrit

## Mass

## BCI

## CEWL

```{r}
powerSim(CEWL_mod, fixed("humidity_tmt_percent:day", "lr"), nsim = 20)
```


```{r}
CEWL_mod_ext <- extend(CEWL_mod,
                       within = "humidity_tmt_percent +
                       trial_number", 
                       n = 10)
```

Next, run powerSim to determine the power for the various sample sizes.

```{r}
# designate effect size desired to detect
fixef(CEWL_mod_ext) <- 1/26 # just estimating rn.... so small... 
# run simulation
CEWL_sim <- powerCurve(CEWL_mod_ext, 
                     test = fixed('humidity_tmt_percent:day', 'lr'),
                     within = "humidity_tmt_percent+
                       trial_number"
                     )
```

Finally, plot to see how sample size affects power:

```{r}
plot(CEWL_sim)
```























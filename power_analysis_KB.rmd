---
title: "Power Analysis for Future Hydration Studies"
author: "Savannah Weaver"
date: "June 2021"
output: pdf_document
---

# Packages

```{r setup, include=FALSE}
if (!require("tidyverse")) install.packages("tidyverse")
library("tidyverse")
if (!require("UsingR")) install.packages("UsingR")
library("UsingR")
if (!require("pwr")) install.packages("pwr")
library("pwr") # basic power analysis
if (!require("simr")) install.packages("simr")
library("simr") # more complex power analysis
if (!require("nlme")) install.packages("nlme")
library("nlme") # for LMMs
```


# Goals

Perform a power analysis on preliminary data to figure out how many lizards I would need to have in my study to find significant differences in hematocrit, osmolality, and evaporative water loss based on climate treatment, if those differences are there. 

Factors to remember/include:
- 2x2 factorial treatment groups
- measurements over time (start, middle, end)
- trial number and individual as random factors



# Load Data

```{r load data}
# CEWL data
CEWL <- read.csv("./exported_data/exp_effects_CEWL.csv",
                             na.strings=c("","NA")
                             ) %>%
  dplyr::mutate(date = as.Date(date, format = "%Y-%m-%d"),
                region = as.factor(region),
                humidity_tmt_percent = as.factor(humidity_tmt_percent),
                individual_ID = as.factor(individual_ID),
                trial_number = as.factor(trial_number),
                day = as.factor(day)
                ) %>%
  dplyr::select(-X) %>%
  dplyr::filter(complete.cases(TEWL_g_m2h))
summary(CEWL)


```





# Data Prep

Since my first try of doing this experiment only had temperature 25C, I'm going to duplicate the data and remake it as 35C so I can build a model off of that.

*Does this even make sense?*


## CEWL

```{r}
# make fake
fake_35C_CEWL <- CEWL %>%
  mutate(temp_tmt_C = 35)

# join & format
fake_CEWL_dat <- fake_35C_CEWL %>%
  rbind(CEWL) %>%
  # make indiv ID and trial num factors
  mutate(individual_ID = as.factor(individual_ID),
         trial_number = as.factor(trial_number))

# check
summary(fake_CEWL_dat)
```




```{r}
num_liz <- (4:10)*10

CEWL_mod <- lme4::lmer(data = fake_CEWL_dat,
                         TEWL_g_m2h ~ 
                         temp_tmt_C*humidity_tmt_percent*day + region +
                         (1|trial_number/individual_ID))

extensions <- purrr::map(num_liz,
                  function(x) 
                    extend(CEWL_mod, along = "individual_ID", n = x))

powersims <- map_dfr(extensions,
                 ~powerSim(.x,
                           fixed("humidity_tmt_percent:day", "lr"), 
                           nsim = 20) %>%
                   summary()
)

powersims$sample_size = num_liz

powersims %>%
  ggplot(aes(x = sample_size, y = mean)) +
  geom_point() +
  geom_line() +
  theme_classic() +
  geom_hline(yintercept = .8) +
  geom_errorbar(aes(ymin = lower, ymax = upper))
```




















